<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BiSual - Oyna</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/static/js/theme.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #020617;
            /* Mesh-bg and Light-bg handle the background images now */
            color: white;
            user-select: none;
            /* Mobile Safe Areas */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            /* Prevent bounce */
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Dark Mode Background */
        .mesh-bg {
            position: absolute;
            inset: 0;
            z-index: -1;
            background:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            opacity: 1;
            transition: opacity 0.5s;
        }

        /* Light Mode Background */
        .light-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            background:
                radial-gradient(at 0% 0%, hsla(210, 100%, 96%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(220, 100%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(190, 100%, 95%, 1) 0, transparent 50%);
            opacity: 0;
            transition: opacity 0.5s;
        }

        html:not(.dark) .mesh-bg {
            opacity: 0;
        }

        html:not(.dark) .light-bg {
            opacity: 1;
        }

        /* Text Colors */
        html:not(.dark) body {
            color: #1e293b;
            background-color: #f8fafc;
        }

        html.dark body {
            color: white;
            background-color: #020617;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        html.dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .input-glass:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .btn-premium {
            background: linear-gradient(to bottom, #6366f1, #4f46e5);
            box-shadow: 0 6px 0 #312e81, 0 15px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.1s;
            transform: translateY(0);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-premium:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #312e81, 0 5px 10px rgba(0, 0, 0, 0.4);
        }

        .answer-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.1s;
            border-bottom: 6px solid rgba(0, 0, 0, 0.3);
            transform: translateY(0);
        }

        .answer-btn:active {
            transform: translateY(6px);
            border-bottom-width: 0;
            margin-bottom: 6px;
            /* Prevent layout shift */
        }

        /* Animations */
        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-bounce-slow {
            animation: bounce 3s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        .ring-animation::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #6366f1;
            animation: pulse-ring 2s infinite;
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col" x-data="playerGame()" x-cloak>

    <div class="mesh-bg"></div>
    <div class="light-bg"></div>

    <!-- Background Music -->
    <audio id="waitingMusic" loop>
        <source src="https://cdn.pixabay.com/audio/2022/02/07/audio_1204a3f121.mp3" type="audio/mpeg">
    </audio>

    <!-- HEADER -->
    <div class="h-16 px-6 flex justify-between items-center z-20 w-full absolute top-0 left-0"
        x-show="state !== 'LOGIN'">
        <div class="glass-panel px-4 py-2 rounded-full flex items-center gap-2">
            <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">PIN</span>
            <span class="font-mono font-bold text-lg" x-text="pin"></span>
        </div>

        <div class="flex items-center gap-3">
            <div class="glass-panel px-4 py-2 rounded-full font-bold flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                <span x-text="nickname"></span>
            </div>
            <div class="glass-panel px-3 py-2 rounded-full font-black text-indigo-400" x-show="score > 0"
                x-text="score"></div>
        </div>
    </div>

    <!-- 1. LOGIN SCREEN -->
    <div x-show="state === 'LOGIN'" class="flex-1 flex flex-col items-center justify-center p-6 relative"
        x-transition.opacity>
        <!-- Floating shapes background -->
        <div class="absolute top-1/4 left-1/4 text-6xl opacity-20 animate-float select-none"
            style="animation-delay: 0s;">‚ö°</div>
        <div class="absolute bottom-1/4 right-1/4 text-6xl opacity-20 animate-float select-none"
            style="animation-delay: 2s;">üéÆ</div>

        <div class="w-full max-w-md glass-panel p-8 rounded-3xl text-center relative z-10 backdrop-blur-xl">
            <div
                class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-xl shadow-indigo-500/30 transform rotate-3">
                <span class="text-4xl text-white">üöÄ</span>
            </div>

            <h1 class="text-3xl font-black mb-2 tracking-tight text-white">BiSual</h1>
            <p class="text-slate-400 mb-8 text-sm">Yarƒ±≈ümaya katƒ±lmak i√ßin ismini gir</p>

            <div class="space-y-4">
                <div class="relative">
                    <input type="text" x-model="nickname"
                        class="input-glass w-full rounded-2xl p-4 text-center text-xl font-bold outline-none placeholder-slate-500"
                        placeholder="Adƒ±nƒ±z" maxlength="12" autofocus>
                </div>

                <button @click="join()"
                    class="w-full btn-premium py-4 rounded-2xl text-lg font-bold text-white tracking-wide">
                    OYUNA Gƒ∞R
                </button>
            </div>
        </div>

        <div class="mt-8 text-slate-500 text-xs text-center relative z-10">
            Hazƒ±r mƒ±sƒ±n? Sahne senin!
        </div>
    </div>

    <!-- 2. WAITING SCREEN -->
    <div x-show="state === 'WAITING'"
        class="flex-1 flex flex-col items-center justify-center p-6 text-center relative overflow-hidden"
        x-transition.opacity>

        <!-- New Pulse Animation -->
        <div class="relative w-40 h-40 flex items-center justify-center mb-12">
            <div class="absolute inset-0 bg-indigo-500 rounded-full animate-ping opacity-20 duration-1000"></div>
            <div class="absolute inset-4 bg-purple-500 rounded-full animate-ping opacity-20 duration-1000 delay-300">
            </div>

            <div
                class="w-32 h-32 bg-slate-900 rounded-full flex items-center justify-center relative z-10 shadow-[0_0_50px_rgba(99,102,241,0.5)] border-4 border-slate-800">
                <span class="text-5xl animate-[bounce_2s_infinite]">‚è≥</span>
            </div>

            <!-- Orbiting Particles -->
            <div class="absolute inset-0 animate-spin duration-[10s] linear">
                <div
                    class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 w-4 h-4 bg-cyan-400 rounded-full shadow-[0_0_10px_rgba(34,211,238,0.8)]">
                </div>
            </div>
        </div>

        <h2
            class="text-4xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">
            Hazƒ±r Ol!
        </h2>

        <div class="glass-panel px-8 py-6 rounded-2xl mb-8 max-w-xs mx-auto backdrop-blur-xl border border-white/10">
            <p class="text-slate-600 dark:text-slate-300 text-lg font-medium">G√∂z√ºn ekranda olsun...</p>
        </div>

        <!-- Music Toggle -->
        <button
            @click="const music = document.getElementById('waitingMusic'); music.paused ? music.play() : music.pause()"
            class="flex items-center gap-2 bg-white/5 hover:bg-white/10 px-4 py-2 rounded-full text-sm transition text-slate-400 hover:text-white border border-white/5">
            <span>üéµ</span> <span>Lobi M√ºziƒüi</span>
        </button>

        <!-- Current Score Display (if re-entering lobby) -->
        <div x-show="score > 0" class="mt-12 text-center" x-transition.enter>
            <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">PUANIN</div>
            <div class="text-5xl font-black text-white drop-shadow-lg" x-text="score"></div>
        </div>
    </div>

    <!-- 3. ANSWERING SCREEN -->
    <div x-show="state === 'ANSWERING'" class="flex-1 flex flex-col relative" x-transition.opacity>

        <!-- Timer Bar -->
        <div class="absolute top-[64px] left-0 w-full h-1.5 bg-white/5">
            <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-[1000ms] linear shadow-[0_0_10px_rgba(99,102,241,0.5)]"
                :style="'width: ' + timerPercent + '%'"></div>
        </div>

        <!-- Timer Count (Floating) -->
        <div class="absolute top-20 right-6 font-black text-4xl text-white/10 select-none z-0" x-text="timerValue">
        </div>

        <!-- Question Text (Mobile) -->
        <div class="mt-24 px-6 mb-4 text-center relative z-10">
            <div class="text-lg font-medium text-white/90 leading-snug drop-shadow-md" x-text="currentQuestion.text">
            </div>
        </div>

        <!-- DYNAMIC CONTENT -->
        <div class="flex-1 p-4 pb-8 flex flex-col justify-center max-w-2xl mx-auto w-full relative z-10">

            <div x-show="['multiple_choice', 'poll'].includes(currentQuestion.q_type)"
                class="flex-1 grid grid-cols-2 gap-3 w-full h-full max-h-[60vh] min-h-[300px]">

                <button @click="submitAnswer(0)"
                    class="answer-btn bg-red-500 rounded-2xl flex flex-col items-center justify-center p-4 shadow-[0_4px_0_rgb(153,27,27)] active:shadow-none active:translate-y-[4px] transition-all touch-manipulation">
                    <div
                        class="bg-black/20 w-10 h-10 md:w-14 md:h-14 rounded-full flex items-center justify-center mb-1 md:mb-3 backdrop-blur-sm">
                        <span class="text-xl md:text-3xl text-white">‚ñ≤</span>
                    </div>
                </button>

                <button @click="submitAnswer(1)"
                    class="answer-btn bg-blue-600 rounded-2xl flex flex-col items-center justify-center p-4 shadow-[0_4px_0_rgb(37,99,235)] active:shadow-none active:translate-y-[4px] transition-all touch-manipulation">
                    <div
                        class="bg-black/20 w-10 h-10 md:w-14 md:h-14 rounded-full flex items-center justify-center mb-1 md:mb-3 backdrop-blur-sm">
                        <span class="text-xl md:text-3xl text-white">‚óÜ</span>
                    </div>
                </button>

                <button @click="submitAnswer(2)"
                    class="answer-btn bg-yellow-500 rounded-2xl flex flex-col items-center justify-center p-4 shadow-[0_4px_0_rgb(202,138,4)] active:shadow-none active:translate-y-[4px] transition-all touch-manipulation">
                    <div
                        class="bg-black/20 w-10 h-10 md:w-14 md:h-14 rounded-full flex items-center justify-center mb-1 md:mb-3 backdrop-blur-sm">
                        <span class="text-xl md:text-3xl text-white">‚óè</span>
                    </div>
                </button>

                <button @click="submitAnswer(3)"
                    class="answer-btn bg-green-600 rounded-2xl flex flex-col items-center justify-center p-4 shadow-[0_4px_0_rgb(22,163,74)] active:shadow-none active:translate-y-[4px] transition-all touch-manipulation">
                    <div
                        class="bg-black/20 w-10 h-10 md:w-14 md:h-14 rounded-full flex items-center justify-center mb-1 md:mb-3 backdrop-blur-sm">
                        <span class="text-xl md:text-3xl text-white">‚ñ†</span>
                    </div>
                </button>
            </div>

            <!-- 2. TRUE / FALSE -->
            <div x-show="currentQuestion.q_type === 'true_false'" class="h-full max-h-[400px] grid grid-cols-1 gap-4">
                <button @click="submitAnswer(0)"
                    class="answer-btn bg-blue-600 rounded-2xl flex items-center justify-center gap-6 shadow-xl shadow-blue-600/20">
                    <div class="bg-white/20 p-3 rounded-lg"><span class="text-3xl text-white">‚óÜ</span></div>
                    <span class="text-3xl font-black text-white tracking-widest">DOƒûRU</span>
                </button>
                <button @click="submitAnswer(1)"
                    class="answer-btn bg-red-600 rounded-2xl flex items-center justify-center gap-6 shadow-xl shadow-red-600/20">
                    <div class="bg-white/20 p-3 rounded-lg"><span class="text-3xl text-white">‚ñ≤</span></div>
                    <span class="text-3xl font-black text-white tracking-widest">YANLI≈û</span>
                </button>
            </div>

            <!-- 3. TYPING -->
            <div x-show="currentQuestion.q_type === 'typing'"
                class="flex flex-col items-center justify-center gap-6 glass-panel p-8 rounded-3xl">
                <h3 class="font-bold text-xl text-indigo-200">Cevabƒ±nƒ± Yaz</h3>
                <input type="text" x-model="textAnswer"
                    class="input-glass w-full p-4 rounded-xl text-center text-2xl font-bold uppercase outline-none focus:border-indigo-500 transition"
                    placeholder="Buraya yaz...">
                <button @click="submitAnswer(textAnswer)"
                    class="w-full btn-premium py-4 rounded-xl text-xl font-bold text-white">
                    G√ñNDER
                </button>
            </div>

            <!-- 4. MARKED ANSWER -->
            <div x-show="currentQuestion.q_type === 'marked_answer'"
                class="flex-1 flex flex-col items-center justify-center gap-4 w-full h-full">
                <div
                    class="relative w-full flex-1 bg-black/40 rounded-2xl overflow-hidden border border-white/10 shadow-2xl">
                    <div class="relative w-full h-full flex items-center justify-center" x-show="currentQuestion.image"
                        @click="setPin($event)">
                        <img :src="currentQuestion.image"
                            class="max-w-full max-h-full object-contain pointer-events-none">
                        <!-- Pin Overlay -->
                        <div class="absolute inset-0 cursor-crosshair"></div>
                        <!-- Pin Marker -->
                        <div x-show="pinCoords"
                            class="absolute text-4xl -ml-4 -mt-8 drop-shadow-xl transition-all duration-300 bounce-in"
                            :style="'left: ' + pinCoords.x + '%; top: ' + pinCoords.y + '%'">
                            üìç
                        </div>
                    </div>
                    <div x-show="!currentQuestion.image"
                        class="absolute inset-0 flex items-center justify-center text-slate-500">
                        G√∂rsel y√ºkleniyor...
                    </div>
                </div>

                <button x-show="pinCoords" @click="submitAnswer(pinCoords.x + ',' + pinCoords.y)"
                    class="w-full btn-premium py-4 rounded-xl text-xl font-bold text-white glass-panel border-t border-white/20">
                    G√ñNDER
                </button>
                <div x-show="!pinCoords"
                    class="text-sm text-indigo-300 bg-indigo-500/10 px-4 py-2 rounded-full border border-indigo-500/20">
                    üëÜ G√∂rselin √ºzerine dokun
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ANSWER SENT SCREEN (Waiting for others) -->
    <div x-show="state === 'ANSWER_SENT'" class="flex-1 flex flex-col items-center justify-center p-6 text-center"
        x-transition.opacity>
        <div
            class="w-24 h-24 bg-indigo-600 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-indigo-600/40 animate-pulse">
            <span class="text-4xl">üöÄ</span>
        </div>
        <h2 class="text-3xl font-black text-white mb-2">Cevap G√∂nderildi!</h2>
        <p class="text-slate-400 mb-6">Diƒüerlerini bekliyoruz...</p>

        <!-- Question Review -->
        <div x-show="currentQuestion.text"
            class="glass-panel p-4 rounded-xl w-full max-w-sm text-left border border-white/10">
            <p class="text-slate-400 text-xs uppercase font-bold mb-1">SORU</p>
            <p class="text-white font-medium leading-tight" x-text="currentQuestion.text"></p>
        </div>

        <div class="mt-8 flex gap-2">
            <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
        </div>
    </div>

    <!-- 5. FEEDBACK SCREEN (Unified) -->
    <div x-show="state === 'FEEDBACK'"
        class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 transition-colors duration-500"
        :class="lastResult === 'CORRECT' ? 'bg-green-600' : 'bg-red-600'">

        <div
            class="bg-white rounded-[2rem] p-8 text-center shadow-2xl max-w-sm w-full transform transition-all duration-500">
            <div class="text-7xl mb-4">
                <span x-show="lastResult === 'CORRECT'">üéâ</span>
                <span x-show="lastResult === 'WRONG'">‚ùå</span>
            </div>

            <h2 class="text-4xl font-black mb-2 text-slate-900"
                x-text="lastResult === 'CORRECT' ? 'DOƒûRU!' : 'YANLI≈û!'"></h2>

            <div x-show="lastResult === 'CORRECT'" class="mb-4">
                <span class="text-3xl font-black text-green-600">+<span x-text="lastPoints"></span></span>
                <span class="text-slate-500 text-sm font-bold ml-1">PUAN</span>
            </div>

            <div class="bg-slate-100 rounded-xl p-4 mt-6 text-left">
                <div class="text-xs text-slate-500 font-bold uppercase mb-1">Doƒüru Cevap</div>
                <div class="text-lg font-bold text-slate-900 leading-tight"
                    x-text="feedbackCorrectAnswer || 'Belirtilmedi'"></div>
            </div>

            <div class="bg-slate-50 rounded-xl p-4 mt-2 text-left border border-slate-200">
                <div class="text-xs text-slate-400 font-bold uppercase mb-1">Soru</div>
                <div class="text-sm font-medium text-slate-600 leading-tight" x-text="feedbackQuestion"></div>
            </div>

            <div x-show="streak > 2" class="mt-4 flex justify-center items-center gap-2 text-orange-500 font-bold">
                <span>üî•</span>
                <span><span x-text="streak"></span> Seri!</span>
            </div>
        </div>
    </div>

    <!-- 6. GAME OVER -->
    <div x-show="state === 'GAME_OVER'" class="flex-1 flex flex-col items-center justify-center" x-transition>
        <h1 class="text-4xl font-black mb-4">Oyun Bitti!</h1>
        <div class="glass-panel p-8 rounded-3xl text-center w-full max-w-sm">
            <div class="text-sm text-slate-400 uppercase tracking-widest mb-2">TOPLAM PUAN</div>
            <div class="text-6xl font-black text-indigo-400 mb-6" x-text="score"></div>
            <a href="/" class="block w-full btn-premium py-3 rounded-xl text-white font-bold">√áƒ±kƒ±≈ü Yap</a>
        </div>
    </div>
    </div>
    </div>

    <!-- FEEDBACK SCREEN -->
    <div x-show="state === 'FEEDBACK'"
        class="flex col h-full items-center justify-center p-6 text-center animate-pulse relative"
        :class="lastResult === 'CORRECT' ? 'bg-green-500' : 'bg-red-500'" x-transition>

        <div x-show="lastResult === 'CORRECT'">
            <div class="text-8xl mb-4">ü§©</div>
            <h2 class="text-5xl font-black text-white mb-4">HARƒ∞KA!</h2>
            <div class="text-3xl font-bold text-white/90">+<span x-text="lastPoints"></span> Puan</div>

            <!-- STREAK -->
            <div x-show="streak > 1" class="mt-8 bg-white/20 px-6 py-3 rounded-full animate-bounce">
                <span class="text-3xl">üî•</span>
                <span class="text-2xl font-black text-white ml-2" x-text="streak + ' Seri!'"></span>
            </div>
        </div>

        <div x-show="lastResult === 'WRONG'">
            <div class="text-8xl mb-4">üò¢</div>
            <h2 class="text-5xl font-black text-white mb-4">HAY AKSƒ∞...</h2>
            <div class="text-2xl font-bold text-white/80">Bir dahakine!</div>
        </div>
        <div class="fixed bottom-10 flex flex-col items-center">
            <div class="text-xs text-white/70 font-bold tracking-widest uppercase">Puanƒ±n</div>
            <div class="font-black text-2xl text-white drop-shadow-md" x-text="score"></div>
        </div>
        <!-- Timer Text -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 font-black text-4xl text-white drop-shadow-lg"
            x-show="state === 'ANSWERING'" x-text="timerValue"></div>
        <div class="bg-white/20 px-4 py-2 rounded-xl backdrop-blur-md border border-white/10"></div>
    </div>

    <script>
        function playerGame() {
            return {
                state: 'LOGIN', // LOGIN, WAITING, ANSWERING, FEEDBACK
                pin: new URLSearchParams(window.location.search).get('pin') || '',
                nickname: '',
                ws: null,
                // Data
                score: 0,
                lastResult: '',
                lastPoints: 0,
                streak: 0,
                timerValue: 0,
                questionStartTime: 0,
                timerPercent: 100,
                timerPercent: 100,
                timerInterval: null,

                sounds: {
                    correct: new Audio('https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg'),
                    wrong: new Audio('https://actions.google.com/sounds/v1/cartoon/clown_horn.ogg'),
                    click: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg')
                },

                // Question Data
                currentQuestion: {
                    text: '',
                    q_type: 'multiple_choice',
                    image: '',
                    time: 20
                },
                textAnswer: '',
                pinCoords: null,
                theme: 'standard',

                join() {
                    if (this.pin.length < 1 || this.nickname.length < 1) return alert("Bilgileri doldurun.");

                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/player/${this.pin}/${this.nickname}`;

                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        this.state = 'WAITING';
                    };

                    this.ws.onmessage = (event) => this.handleMessage(JSON.parse(event.data));

                    this.ws.onclose = () => {
                        console.log("Disconnected");
                    };
                },

                handleMessage(data) {
                    console.log("Msg:", data);

                    if (data.type === 'ERROR') {
                        alert(data.message);
                        this.ws.close();
                    }
                    else if (data.type === 'GAME_JOINED') {
                        this.state = 'WAITING';
                        this.score = data.score;
                        // Apply theme if sent
                        if (data.theme) document.body.className = `theme-${data.theme}`;
                        // Play waiting music
                        const music = document.getElementById('waitingMusic');
                        if (music) music.play().catch(e => console.log('Music autoplay blocked:', e));
                    }
                    else if (data.type === 'NEW_QUESTION') {
                        this.state = 'ANSWERING';
                        this.currentQuestion = data;
                        this.questionStartTime = Date.now();

                        // Pause waiting music
                        const music = document.getElementById('waitingMusic');
                        if (music) music.pause();

                        // Reset Inputs
                        this.textAnswer = '';
                        this.pinCoords = null;

                        // Timer logic
                        this.startTimer(data.time);
                    }
                    else if (data.type === 'FEEDBACK') {
                        this.state = 'FEEDBACK';
                        this.lastResult = data.result;
                        this.score = data.score;
                        if (data.streak) this.streak = data.streak; else this.streak = 0;
                        if (data.points_added) this.lastPoints = data.points_added;

                        // New fields
                        this.feedbackQuestion = data.question_text || '';
                        this.feedbackCorrectAnswer = data.correct_answer || '';

                        // Audio Feedback
                        if (this.lastResult === 'CORRECT') {
                            this.sounds.correct.currentTime = 0;
                            this.sounds.correct.play().catch(e => { });
                        } else {
                            this.sounds.wrong.currentTime = 0;
                            this.sounds.wrong.play().catch(e => { });
                        }

                        setTimeout(() => {
                            if (this.state === 'FEEDBACK') this.state = 'WAITING';
                        }, 5000);
                    }
                    else if (data.type === 'QUESTION_RESULT') {
                        // Optional: Show detail summary if needed
                        // For now FEEDBACK handles mostly everything
                        this.score = data.total_score;
                        this.streak = data.streak;
                    }
                    else if (data.type === 'GAME_OVER') {
                        alert("Oyun Bitti! Skorun: " + this.score);
                        window.location.reload();
                    }
                },

                submitAnswer(answer) {
                    if (this.state !== 'ANSWERING') return;

                    // Haptic Feedback
                    if (navigator.vibrate) navigator.vibrate(50);

                    const timeElapsed = (Date.now() - this.questionStartTime) / 1000;
                    const estTimeLeft = Math.max(0, this.currentQuestion.time - timeElapsed);

                    this.ws.send(JSON.stringify({
                        type: 'SUBMIT_ANSWER',
                        answer: answer,
                        time_left: estTimeLeft
                    }));

                    this.state = 'ANSWER_SENT';
                },

                setPin(event) {
                    const rect = event.target.getBoundingClientRect(); // Get image rect
                    const x = ((event.clientX - rect.left) / rect.width) * 100;
                    const y = ((event.clientY - rect.top) / rect.height) * 100;
                    this.pinCoords = { x: x.toFixed(2), y: y.toFixed(2) };
                },

                startTimer(seconds) {
                    clearInterval(this.timerInterval);
                    this.timerPercent = 100;
                    this.timerValue = seconds; // Set text timer
                    const step = 100 / (seconds * 10);

                    this.timerInterval = setInterval(() => {
                        this.timerPercent -= step;
                        // Update text timer every second approximately
                        if (this.timerPercent % (100 / seconds) < step) {
                            this.timerValue = Math.ceil(this.timerPercent / (100 / seconds));
                        }

                        if (this.timerPercent <= 0) {
                            clearInterval(this.timerInterval);
                            this.timerValue = 0;
                            // Time's up logic if needed
                        }
                    }, 100);
                }
            }
        }
    </script>
</body>

</html>