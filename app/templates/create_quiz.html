<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiSual - Yarƒ±≈üma Olu≈ütur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f2f2f2;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .slide-card {
            transition: all 0.2s;
        }

        .slide-card.active {
            border-color: #46178f;
            box-shadow: 0 0 0 2px #46178f;
            background-color: #f0f4ff;
        }

        .answer-input-container {
            transition: all 0.2s;
        }

        .answer-input-container:focus-within {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script>
        // Inject quiz data if in edit mode
        window.serverQuizData = {{ quiz_json | tojson | safe if quiz_json else 'null' }};

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    </script>
</head>

<body class="h-screen flex flex-col" x-data="quizEditor">

    <!-- TOP NAVBAR -->
    <nav class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-4 z-20 shadow-sm shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-indigo-600 rounded-sm"></div> <!-- Logo Placeholder -->
            <input type="text" x-model="quiz.title"
                class="font-bold text-lg border border-transparent hover:border-gray-300 rounded px-2 py-1 outline-none focus:border-indigo-600 transition"
                placeholder="Yarƒ±≈üma ba≈ülƒ±ƒüƒ± gir...">

            <button @click="showSettings = true"
                class="bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded text-sm font-bold text-gray-700 transition">Ayarlar</button>
        </div>

        <div class="flex gap-3">
            <button @click="window.location.href='/'"
                class="px-4 py-2 font-bold text-gray-500 hover:bg-gray-100 rounded transition">√áƒ±k</button>
            <button @click="saveQuiz()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded font-bold transition shadow-sm">Kaydet</button>
        </div>
    </nav>

    <!-- MAIN EDITOR AREA -->
    <div class="flex-1 flex overflow-hidden">

        <!-- LEFT SIDEBAR (SLIDES) -->
        <div class="w-48 bg-white border-r border-gray-200 flex flex-col p-2 overflow-y-auto shrink-0">
            <div class="flex flex-col gap-3">
                <template x-for="(q, index) in quiz.questions" :key="index">
                    <div @click="currentIndex = index"
                        class="slide-card p-3 rounded-lg border-2 border-gray-200 cursor-pointer relative group flex flex-col gap-2 h-28 hover:bg-gray-50 bg-white"
                        :class="{'active': currentIndex === index}">

                        <div class="text-xs font-bold text-gray-500 flex justify-between">
                            <span x-text="index + 1"></span>
                            <button @click.stop="removeQuestion(index)"
                                class="opacity-0 group-hover:opacity-100 text-red-500 hover:bg-red-100 rounded px-1">üóëÔ∏è</button>
                        </div>

                        <!-- Mini Preview -->
                        <div class="flex-1 bg-gray-100 rounded flex items-center justify-center overflow-hidden">
                            <span class="text-[0.5rem] text-gray-400 text-center px-1 truncate"
                                x-text="q.text || 'Soru ...'"></span>
                        </div>

                        <div class="flex justify-center gap-0.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-yellow-500"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                        </div>
                    </div>
                </template>
            </div>

            <button @click="addQuestion()"
                class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded shadow-lg font-bold transition transform active:scale-95">
                + Soru Ekle
            </button>

            <div class="mt-4 flex gap-2">
                <button @click="showAiModal = true"
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded font-bold text-xs"
                    title="AI ile Ekle">
                    ‚ú® AI
                </button>
                <button @click="showExcelModal = true"
                    class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded font-bold text-xs"
                    title="Excel'den Ekle">
                    üìä Excel
                </button>
            </div>
        </div>

        <!-- CENTER CANVAS -->
        <div class="flex-1 bg-gray-100 p-8 flex flex-col items-center overflow-y-auto relative transition-all duration-500"
            :class="{
                'bg-[url(\'https://www.transparenttextures.com/patterns/cubes.png\')]': quiz.theme === 'standard',
                'bg-blue-100': quiz.theme === 'winter',
                'bg-green-100': quiz.theme === 'spring',
                'bg-yellow-100': quiz.theme === 'summer',
                'bg-orange-100': quiz.theme === 'autumn',
                'bg-gradient-to-br from-blue-500 to-yellow-400': quiz.theme === 'ukraine'
             }">

            <div class="w-full max-w-4xl flex-1 flex flex-col gap-6">

                <!-- Question Input -->
                <div class="bg-white p-2 rounded shadow-sm">
                    <input type="text" x-model="currentQuestion.text"
                        class="w-full text-center text-3xl font-bold p-4 outline-none placeholder-gray-300 text-gray-800"
                        placeholder="Sorunu girmeye ba≈üla">
                </div>

                <!-- Media Area -->
                <div class="flex-1 bg-white rounded flex items-center justify-center min-h-[300px] border-2 border-dashed border-gray-300 relative group cursor-pointer hover:border-indigo-400 transition hover:bg-indigo-50"
                    @click="$refs.fileInput.click()">

                    <input type="file" x-ref="fileInput" class="hidden" accept="image/*" @change="uploadImage($event)">

                    <div class="text-center">
                        <div class="text-6xl mb-4 opacity-20">üñºÔ∏è</div>
                        <div class="font-bold text-gray-400 group-hover:text-indigo-500"
                            x-show="!currentQuestion.image_url">
                            Resim Y√ºkle<br>
                            <span class="text-xs font-normal opacity-70">(veya s√ºr√ºkle bƒ±rak)</span>
                        </div>
                    </div>

                    <!-- Image Preview -->
                    <div x-show="currentQuestion.image_url"
                        class="absolute inset-0 w-full h-full bg-gray-50 group-hover:opacity-50 transition p-4">
                        <img :src="currentQuestion.image_url" class="w-full h-full object-contain">
                    </div>

                    <!-- Hover Action -->
                    <div x-show="currentQuestion.image_url"
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-10">
                        <span
                            class="bg-indigo-600 text-white px-4 py-2 rounded-full font-bold shadow-lg">Deƒüi≈ütir</span>
                    </div>
                </div>

                <!-- Answer Grid -->
                <!-- Answer Grid (Dynamic) -->
                <div class="grid grid-cols-2 gap-4 h-64"
                    x-show="['multiple_choice', 'poll'].includes(currentQuestion.question_type)">
                    <template x-for="(opt, idx) in currentQuestion.options" :key="idx">
                        <div class="answer-input-container rounded-lg p-3 flex items-center gap-3 shadow-sm group transition"
                            :class="{
                                'bg-red-600': idx === 0,
                                'bg-blue-600': idx === 1,
                                'bg-yellow-500': idx === 2,
                                'bg-green-600': idx === 3
                             }">
                            <div class="w-10 h-10 flex items-center justify-center text-white text-2xl font-bold"
                                x-text="['‚ñ≤','‚óÜ','‚óè','‚ñ†'][idx]"></div>
                            <div class="flex-1 h-full bg-white rounded flex items-center px-4 relative">
                                <input type="text" x-model="opt.text"
                                    class="w-full h-full outline-none font-medium text-gray-700"
                                    :placeholder="'Cevap ekle ' + (idx+1)">
                                <button x-show="currentQuestion.question_type !== 'poll'" @click="toggleCorrect(idx)"
                                    class="w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center ml-2 transition hover:bg-green-50"
                                    :class="opt.is_correct ? 'bg-green-500 border-green-500 text-white' : 'text-transparent'">
                                    ‚úì
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- True/False Grid -->
                <div class="grid grid-cols-2 gap-4 h-64" x-show="currentQuestion.question_type === 'true_false'">
                    <div class="h-full bg-blue-600 rounded-lg flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-[1.02] active:scale-95 shadow-lg relative border-4"
                        :class="currentQuestion.options[0].is_correct ? 'border-green-400' : 'border-transparent'"
                        @click="setTrueFalse(0)">
                        <div class="text-white text-4xl font-black mb-2">DOƒûRU</div>
                        <div class="text-blue-200 text-6xl">‚óÜ</div>
                        <div x-show="currentQuestion.options[0].is_correct"
                            class="absolute top-4 right-4 bg-green-500 text-white rounded-full p-2 text-xl font-bold">‚úì
                        </div>
                    </div>
                    <div class="h-full bg-red-600 rounded-lg flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-[1.02] active:scale-95 shadow-lg relative border-4"
                        :class="currentQuestion.options[1].is_correct ? 'border-green-400' : 'border-transparent'"
                        @click="setTrueFalse(1)">
                        <div class="text-white text-4xl font-black mb-2">YANLI≈û</div>
                        <div class="text-red-200 text-6xl">‚ñ≤</div>
                        <div x-show="currentQuestion.options[1].is_correct"
                            class="absolute top-4 right-4 bg-green-500 text-white rounded-full p-2 text-xl font-bold">‚úì
                        </div>
                    </div>
                </div>

                <!-- Type Answer -->
                <div class="w-full h-64 bg-white rounded-lg p-8 flex flex-col items-center justify-center shadow-sm"
                    x-show="currentQuestion.question_type === 'typing'">
                    <h3 class="text-gray-500 font-bold mb-4 uppercase tracking-wider">Doƒüru Cevabƒ± Yazƒ±n</h3>
                    <input type="text" x-model="currentQuestion.options[0].text"
                        class="w-full max-w-lg text-center text-3xl font-bold border-b-4 border-gray-300 focus:border-indigo-600 outline-none p-4 transition placeholder-gray-200 text-indigo-600"
                        placeholder="Cevap buraya...">
                    <p class="mt-4 text-xs text-gray-400">B√ºy√ºk/k√º√ß√ºk harf duyarlƒ±lƒ±ƒüƒ± yoktur.</p>
                </div>

                <!-- Pin Drop (Marked Answer) -->
                <div class="w-full h-auto bg-white rounded-lg p-4 flex flex-col items-center justify-center shadow-sm"
                    x-show="currentQuestion.question_type === 'marked_answer'">
                    <div class="text-center mb-4">
                        <h3 class="text-gray-500 font-bold uppercase tracking-wider">Doƒüru Yeri ƒ∞≈üaretleyin</h3>
                        <p class="text-xs text-gray-400">G√∂rselin √ºzerinde doƒüru cevabƒ±n bulunduƒüu noktaya tƒ±klayƒ±n.</p>
                    </div>

                    <!-- Image Container for Pinning -->
                    <div class="relative w-full max-w-2xl border-2 border-indigo-100 rounded-lg overflow-hidden cursor-crosshair group"
                        x-show="currentQuestion.image_url" @click="setPin($event)">

                        <img :src="currentQuestion.image_url" class="w-full h-auto object-contain block">

                        <!-- Pin Marker -->
                        <div x-show="currentQuestion.options[0].text"
                            class="absolute w-8 h-8 -ml-4 -mt-8 text-4xl drop-shadow-lg transition-all duration-200 pointer-events-none"
                            :style="'left: ' + (currentQuestion.options[0].text ? currentQuestion.options[0].text.split(',')[0] + '%' : '50%') + '; top: ' + (currentQuestion.options[0].text ? currentQuestion.options[0].text.split(',')[1] + '%' : '50%')">
                            üìç
                        </div>
                    </div>

                    <div x-show="!currentQuestion.image_url"
                        class="p-8 text-red-400 font-bold bg-red-50 rounded-lg border border-red-200">
                        ‚ö†Ô∏è √ñnce yukarƒ±dan bir g√∂rsel eklemelisiniz.
                    </div>
                </div>

            </div>
        </div>

        <!-- RIGHT SIDEBAR (SETTINGS) -->
        <div class="w-64 bg-white border-l border-gray-200 p-4 shrink-0 flex flex-col gap-6 overflow-y-auto">

            <!-- Type Selector Trigger -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Soru T√ºr√º</label>
                <button @click="showTypeSelector = true"
                    class="w-full bg-white border border-gray-300 hover:border-indigo-500 rounded p-3 flex items-center justify-between shadow-sm transition group">
                    <div class="flex items-center gap-3">
                        <span class="text-xl" x-text="getTypeIcon(currentQuestion.question_type)"></span>
                        <span class="font-bold text-gray-700"
                            x-text="getTypeName(currentQuestion.question_type)"></span>
                    </div>
                </button>
            </div>

            <!-- Time Limit -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Zaman sƒ±nƒ±rƒ±
                </label>
                <button @click="showTimeSelector = true"
                    class="w-full bg-white border border-gray-300 hover:border-indigo-500 rounded p-2 font-bold text-gray-700 flex justify-between items-center shadow-sm transition">
                    <span x-text="formatTime(currentQuestion.time_limit)"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Points -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Puan
                </label>
                <button @click="showPointsSelector = true"
                    class="w-full bg-white border border-gray-300 hover:border-indigo-500 rounded p-2 font-bold text-gray-700 flex justify-between items-center shadow-sm transition">
                    <span x-text="formatPoints(currentQuestion.points)"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Themes Trigger -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Tema</label>
                <button @click="showThemeSelector = true"
                    class="w-full bg-white border border-gray-300 hover:border-indigo-500 rounded p-2 font-bold text-gray-700 flex justify-between items-center shadow-sm transition">
                    <span x-text="getThemeName(quiz.theme)"></span>
                    <span class="text-xl">üé®</span>
                </button>
            </div>

            <div class="mt-auto pt-8 text-center text-gray-300 text-xs text-balance">
                Kahoot Tarzƒ± BiSual<br>Editor V1.0
            </div>

        </div>

        <!-- Success Modal -->
        <div x-show="showSuccess"
            class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm"
            style="display: none;">
            <div class="bg-white p-8 rounded-xl text-center max-w-sm mx-auto shadow-2xl animate-bounce">
                <div class="text-5xl mb-4">üéâ</div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">Hazƒ±r!</h2>
                <p class="text-gray-500 mb-6">Yarƒ±≈üma ba≈üarƒ±yla kaydedildi.</p>
                <a href="/host"
                    class="bg-indigo-600 text-white px-6 py-2 rounded font-bold block w-full hover:bg-indigo-700">
                    Ba≈ülat
                </a>
            </div>
        </div>

        <!-- Type Selector Modal -->
        <div x-show="showTypeSelector" @click.self="showTypeSelector = false"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] backdrop-blur-sm"
            style="display: none;">
            <div class="bg-white p-6 rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">Soru t√ºr√º se√ß</h2>
                    <button @click="showTypeSelector = false"
                        class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Quiz -->
                    <button @click="changeType('multiple_choice')"
                        class="p-4 rounded-xl border-2 hover:border-indigo-500 hover:bg-indigo-50 transition flex flex-col items-center gap-3 text-center h-32 justify-center"
                        :class="currentQuestion.question_type === 'multiple_choice' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'">
                        <div class="text-3xl">üí†</div>
                        <span class="font-bold text-gray-700">Quiz</span>
                    </button>

                    <!-- True/False -->
                    <button @click="changeType('true_false')"
                        class="p-4 rounded-xl border-2 hover:border-indigo-500 hover:bg-indigo-50 transition flex flex-col items-center gap-3 text-center h-32 justify-center"
                        :class="currentQuestion.question_type === 'true_false' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'">
                        <div class="text-3xl flex gap-1"><span class="text-blue-500">‚ñÆ</span><span
                                class="text-red-500">‚ñÆ</span></div>
                        <span class="font-bold text-gray-700">Doƒüru/Yanlƒ±≈ü</span>
                    </button>

                    <!-- Type Answer -->
                    <button @click="changeType('typing')"
                        class="p-4 rounded-xl border-2 hover:border-indigo-500 hover:bg-indigo-50 transition flex flex-col items-center gap-3 text-center h-32 justify-center"
                        :class="currentQuestion.question_type === 'typing' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'">
                        <div class="text-3xl">‚å®Ô∏è</div>
                        <span class="font-bold text-gray-700">Kƒ±sa Cevap</span>
                    </button>

                    <!-- Pin Drop -->
                    <button @click="changeType('marked_answer')"
                        class="p-4 rounded-xl border-2 hover:border-indigo-500 hover:bg-indigo-50 transition flex flex-col items-center gap-3 text-center h-32 justify-center"
                        :class="currentQuestion.question_type === 'marked_answer' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'">
                        <div class="text-3xl">üìç</div>
                        <span class="font-bold text-gray-700">ƒ∞≈üaretli Cevap</span>
                    </button>

                    <!-- Poll -->
                    <button @click="changeType('poll')"
                        class="p-4 rounded-xl border-2 hover:border-indigo-500 hover:bg-indigo-50 transition flex flex-col items-center gap-3 text-center h-32 justify-center"
                        :class="currentQuestion.question_type === 'poll' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'">
                        <div class="text-3xl">üìä</div>
                        <span class="font-bold text-gray-700">Oylama</span>
                    </button>

                    <!-- Coming Soon -->
                    <button
                        class="p-4 rounded-xl border-2 border-gray-100 bg-gray-50 cursor-not-allowed opacity-60 flex flex-col items-center gap-3 text-center h-32 justify-center">
                        <div class="text-2xl grayscale">üß©</div>
                        <span class="font-bold text-gray-400">Puzzle</span>
                    </button>
                    <button
                        class="p-4 rounded-xl border-2 border-gray-100 bg-gray-50 cursor-not-allowed opacity-60 flex flex-col items-center gap-3 text-center h-32 justify-center">
                        <div class="text-2xl grayscale">‚òÅÔ∏è</div>
                        <span class="font-bold text-gray-400">Kelime</span>
                    </button>

                </div>
            </div>
        </div>

        <!-- Time Selector Modal -->
        <div x-show="showTimeSelector" @click.self="showTimeSelector = false"
            class="fixed inset-0 bg-black/50 flex justify-end z-[70] backdrop-blur-sm" style="display: none;"
            x-transition>
            <div class="w-80 bg-white h-full shadow-2xl p-4 overflow-y-auto flex flex-col gap-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">Zaman sƒ±nƒ±rƒ±</h2>
                    <button @click="showTimeSelector = false"
                        class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <template x-for="time in [5, 10, 20, 30, 60, 90, 120, 240]">
                        <button @click="currentQuestion.time_limit = time; showTimeSelector = false"
                            class="p-3 rounded-lg border-2 hover:border-indigo-500 hover:bg-indigo-50 font-bold text-gray-700 transition"
                            :class="currentQuestion.time_limit === time ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'"
                            x-text="formatTime(time)"></button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Points Selector Modal -->
        <div x-show="showPointsSelector" @click.self="showPointsSelector = false"
            class="fixed inset-0 bg-black/50 flex justify-end z-[70] backdrop-blur-sm" style="display: none;"
            x-transition>
            <div class="w-80 bg-white h-full shadow-2xl p-4 overflow-y-auto flex flex-col gap-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">Puanlar</h2>
                    <button @click="showPointsSelector = false"
                        class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                </div>
                <div class="flex flex-col gap-3">
                    <!-- Standard -->
                    <button @click="currentQuestion.points = 1000; showPointsSelector = false"
                        class="p-4 rounded-xl border-2 text-left relative group transition h-24 flex flex-col justify-center"
                        :class="currentQuestion.points === 1000 ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200 hover:border-indigo-300'">
                        <div class="flex justify-between items-center w-full">
                            <span class="font-bold text-gray-800 text-lg">Standart</span>
                            <span x-show="currentQuestion.points === 1000"
                                class="text-xl font-bold text-indigo-600">‚úì</span>
                        </div>
                        <span class="text-xs text-gray-500 mt-1">Doƒüru cevaplarƒ± normal puanla √∂d√ºllendir.</span>
                    </button>

                    <!-- Double Points -->
                    <button @click="currentQuestion.points = 2000; showPointsSelector = false"
                        class="p-4 rounded-xl border-2 text-left relative group transition h-24 flex flex-col justify-center"
                        :class="currentQuestion.points === 2000 ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200 hover:border-indigo-300'">
                        <div class="flex justify-between items-center w-full">
                            <span class="font-bold text-gray-800 text-lg">ƒ∞ki kat puan</span>
                            <span x-show="currentQuestion.points === 2000"
                                class="text-xl font-bold text-indigo-600">‚úì</span>
                        </div>
                        <span class="text-xs text-gray-500 mt-1">Doƒüru cevaplar i√ßin iki kat puan ver.</span>
                    </button>

                    <!-- No Points -->
                    <button @click="currentQuestion.points = 0; showPointsSelector = false"
                        class="p-4 rounded-xl border-2 text-left relative group transition h-24 flex flex-col justify-center"
                        :class="currentQuestion.points === 0 ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200 hover:border-indigo-300'">
                        <div class="flex justify-between items-center w-full">
                            <span class="font-bold text-gray-800 text-lg">0 puan</span>
                            <span x-show="currentQuestion.points === 0"
                                class="text-xl font-bold text-indigo-600">‚úì</span>
                        </div>
                        <span class="text-xs text-gray-500 mt-1">Sorunun √∂d√ºl√ºn√º azalt ve puanlarƒ± kaldƒ±r.</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div x-show="showThemeSelector" @click.self="showThemeSelector = false"
        class="fixed inset-0 bg-black/50 flex justify-end z-[70] backdrop-blur-sm" style="display: none;" x-transition>
        <div class="w-80 bg-white h-full shadow-2xl p-4 overflow-y-auto flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Temalar</h2>
                <button @click="showThemeSelector = false" class="text-2xl hover:bg-gray-100 rounded p-1">√ó</button>
            </div>

            <div>
                <div class="flex justify-between items-center text-gray-500 font-bold text-sm mb-2 cursor-pointer">
                    <span>Temalarƒ±n</span>
                    <span>‚ñº</span>
                </div>
                <div
                    class="border-2 border-dashed border-gray-300 rounded-lg h-24 flex items-center justify-center text-gray-400 cursor-pointer hover:border-indigo-500 hover:text-indigo-500 transition">
                    <span class="text-4xl font-light">+</span>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center text-gray-500 font-bold text-sm mb-2 cursor-pointer">
                    <span>√úcretsiz</span>
                    <span>‚ñº</span>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- Standard -->
                    <div @click="setTheme('standard')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-indigo-900 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'standard' ? 'border-indigo-600' : 'border-transparent'">
                            <!-- Simulating standard background -->
                            <div
                                class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-50">
                            </div>
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'standard' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Standard</div>
                    </div>

                    <!-- Winter -->
                    <div @click="setTheme('winter')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-blue-200 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'winter' ? 'border-indigo-600' : 'border-transparent'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">‚ùÑÔ∏è</div>
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'winter' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Winter</div>
                    </div>

                    <!-- Spring -->
                    <div @click="setTheme('spring')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-green-200 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'spring' ? 'border-indigo-600' : 'border-transparent'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">üå∏</div>
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'spring' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Spring</div>
                    </div>

                    <!-- Summer -->
                    <div @click="setTheme('summer')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-yellow-200 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'summer' ? 'border-indigo-600' : 'border-transparent'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">‚òÄÔ∏è</div>
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'summer' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Summer</div>
                    </div>

                    <!-- Autumn -->
                    <div @click="setTheme('autumn')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-orange-200 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'autumn' ? 'border-indigo-600' : 'border-transparent'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">üçÇ</div>
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'autumn' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Autumn</div>
                    </div>
                    <!-- Ukraine -->
                    <div @click="setTheme('ukraine')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-gradient-to-b from-blue-500 to-yellow-400 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'ukraine' ? 'border-indigo-600' : 'border-transparent'">
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'ukraine' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Support Ukraine</div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    </div>

    <!-- AI SELECTION MODAL -->
    <div x-show="showAiModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative flex flex-col max-h-[80vh]"
            @click.away="showAiModal = false">
            <h2 class="text-2xl font-black text-gray-800 mb-4">‚ú® AI Soru √úretici</h2>

            <!-- Step 1: Input -->
            <div x-show="!aiQuestions.length" class="space-y-4">
                <input type="text" x-model="aiTopic" placeholder="Konu girin (√∂rn: Fotosentez)"
                    class="w-full border p-3 rounded-lg text-lg outline-none focus:border-purple-500">

                <div class="flex gap-4">
                    <input type="number" x-model="aiCount" placeholder="Sayƒ±" class="w-20 border p-3 rounded-lg">
                    <select x-model="aiDifficulty" class="border p-3 rounded-lg flex-1">
                        <option value="easy">Kolay</option>
                        <option value="medium">Orta</option>
                        <option value="hard">Zor</option>
                    </select>
                </div>

                <button @click="fetchAiQuestions()" :disabled="aiLoading"
                    class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 disabled:opacity-50">
                    <span x-show="!aiLoading">Sorularƒ± Getir</span>
                    <span x-show="aiLoading" class="animate-pulse">√úretiliyor...</span>
                </button>
            </div>

            <!-- Step 2: Selection -->
            <div x-show="aiQuestions.length > 0" class="flex-1 overflow-hidden flex flex-col">
                <div class="flex-1 overflow-y-auto space-y-2 mb-4 p-2 border rounded bg-gray-50">
                    <template x-for="(q, idx) in aiQuestions" :key="idx">
                        <div class="flex items-start gap-3 p-3 bg-white rounded shadow-sm cursor-pointer"
                            @click="q.selected = !q.selected" :class="q.selected ? 'ring-2 ring-purple-500' : ''">
                            <div class="mt-1 w-5 h-5 border-2 rounded flex items-center justify-center"
                                :class="q.selected ? 'bg-purple-500 border-purple-500 text-white' : 'border-gray-300'">
                                <span x-show="q.selected" class="text-xs">‚úì</span>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800" x-text="q.text"></div>
                                <div class="text-xs text-gray-400 mt-1" x-text="q.options.find(o=>o.is_correct)?.text">
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="flex gap-3">
                    <button @click="aiQuestions = []"
                        class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Geri</button>
                    <button @click="addSelectedAiQuestions()"
                        class="flex-1 bg-purple-600 text-white font-bold py-2 rounded hover:bg-purple-700">
                        Se√ßilenleri Ekle (<span x-text="aiQuestions.filter(q=>q.selected).length"></span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- EXCEL PARSE MODAL -->
    <div x-show="showExcelModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative" @click.away="showExcelModal = false">
            <h2 class="text-2xl font-black text-gray-800 mb-4">üìä Excel'den Ekle</h2>

            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-emerald-500 transition"
                @click="$refs.excelParseInput.click()">
                <div x-show="!excelLoading">
                    <div class="text-4xl mb-2">üìÇ</div>
                    <div class="font-bold text-gray-500">Dosya Se√ß (.xlsx)</div>
                </div>
                <div x-show="excelLoading" class="text-emerald-500 font-bold animate-pulse">
                    Y√ºkleniyor...
                </div>
            </div>
            <input type="file" x-ref="excelParseInput" class="hidden" accept=".xlsx" @change="parseExcel($event)">

            <div class="mt-4 text-center">
                <a href="/api/import/template" class="text-xs text-indigo-500 underline">√ñrnek ≈ûablon indir</a>
            </div>
        </div>
    </div>

    </div>

    <!-- SETTINGS MODAL -->
    <div x-show="showSettings" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative" @click.away="showSettings = false"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-90"
            x-transition:enter-end="opacity-100 scale-100">

            <h2 class="text-2xl font-black text-gray-800 mb-6">Yarƒ±≈üma Ayarlarƒ±</h2>

            <div class="space-y-6">
                <!-- Player Screen -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-gray-800">üì± Oyuncu Ekranƒ±</div>
                        <div class="text-xs text-gray-500">Sorularƒ± telefonda g√∂ster</div>
                    </div>
                    <button @click="quiz.settings.show_question_on_player = !quiz.settings.show_question_on_player"
                        class="w-12 h-6 rounded-full transition-colors relative"
                        :class="quiz.settings.show_question_on_player ? 'bg-green-500' : 'bg-gray-300'">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform shadow-sm"
                            :class="quiz.settings.show_question_on_player ? 'translate-x-7 left-0' : 'translate-x-1 left-0'">
                        </div>
                    </button>
                </div>

                <!-- Shuffle Options -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-gray-800">üîÄ Karƒ±≈ütƒ±rma</div>
                        <div class="text-xs text-gray-500">≈ûƒ±klarƒ±n yerini karƒ±≈ütƒ±r</div>
                    </div>
                    <button @click="quiz.settings.shuffle_options = !quiz.settings.shuffle_options"
                        class="w-12 h-6 rounded-full transition-colors relative"
                        :class="quiz.settings.shuffle_options ? 'bg-green-500' : 'bg-gray-300'">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform shadow-sm"
                            :class="quiz.settings.shuffle_options ? 'translate-x-7 left-0' : 'translate-x-1 left-0'">
                        </div>
                    </button>
                </div>

                <!-- Leaderboard Frequency -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-gray-800">üèÜ Akƒ±≈ü</div>
                        <div class="text-xs text-gray-500">Her sorudan sonra puan tablosu</div>
                    </div>
                    <button
                        @click="quiz.settings.show_leaderboard_every_question = !quiz.settings.show_leaderboard_every_question"
                        class="w-12 h-6 rounded-full transition-colors relative"
                        :class="quiz.settings.show_leaderboard_every_question ? 'bg-green-500' : 'bg-gray-300'">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform shadow-sm"
                            :class="quiz.settings.show_leaderboard_every_question ? 'translate-x-7 left-0' : 'translate-x-1 left-0'">
                        </div>
                    </button>
                </div>

                <!-- Music Selection -->
                <div>
                    <div class="font-bold text-gray-800 mb-2">üéµ M√ºzik Temasƒ±</div>
                    <select x-model="quiz.settings.music_theme"
                        class="w-full bg-gray-100 border border-gray-300 rounded-lg p-2 outline-none focus:border-indigo-500">
                        <option value="energetic">Enerjik (Standart)</option>
                        <option value="chill">Sakin & Chill</option>
                        <option value="suspense">Gerilim & Aksiyon</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button @click="showSettings = false"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">Tamam</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('quizEditor', () => ({
                currentIndex: 0,
                showSuccess: false,
                showSettings: false,
                showTypeSelector: false,
                showTimeSelector: false,
                showPointsSelector: false,
                showThemeSelector: false,
                showAiModal: false,
                showExcelModal: false,
                aiTopic: '',
                aiCount: 5,
                aiDifficulty: 'medium',
                aiLoading: false,
                aiQuestions: [],
                excelLoading: false,
                uploading: false,
                quiz: {
                    title: '',
                    description: '',
                    theme: 'standard',
                    settings: {
                        show_question_on_player: false,
                        shuffle_options: false,
                        show_leaderboard_every_question: true,
                        music_theme: 'energetic'
                    },
                    questions: [
                        {
                            text: '',
                            time_limit: 20,
                            points: 1000,
                            question_type: 'multiple_choice',
                            image_url: '',
                            options: [
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false }
                            ]
                        }
                    ]
                },

                init() {
                    // Watch for quiz_json from server template
                    if (window.serverQuizData) {
                        this.quiz = window.serverQuizData;
                    }
                },

                async fetchAiQuestions() {
                    if (!this.aiTopic) return alert("L√ºtfen konu girin");
                    this.aiLoading = true;
                    try {
                        const res = await fetch('/api/ai/preview', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': getCookie('csrf_token')
                            },
                            body: JSON.stringify({
                                topic: this.aiTopic,
                                count: parseInt(this.aiCount),
                                difficulty: this.aiDifficulty
                            })
                        });
                        const data = await res.json();
                        if (Array.isArray(data)) {
                            this.aiQuestions = data.map(q => ({ ...q, selected: true })); // Default select all
                        } else {
                            alert("Hata olu≈ütu");
                        }
                    } catch (e) {
                        alert("Sunucu hatasƒ±");
                    } finally {
                        this.aiLoading = false;
                    }
                },

                addSelectedAiQuestions() {
                    const selected = this.aiQuestions.filter(q => q.selected);
                    if (selected.length === 0) return;

                    // Clean up selected property before adding
                    const toAdd = selected.map(({ selected, ...rest }) => rest);

                    this.quiz.questions.push(...toAdd);

                    // Reset
                    this.aiQuestions = [];
                    this.showAiModal = false;
                    this.aiTopic = '';

                    // Scroll to bottom
                    this.$nextTick(() => {
                        const sidebar = document.querySelector('.overflow-y-auto');
                        if (sidebar) sidebar.scrollTop = sidebar.scrollHeight;
                        this.currentIndex = this.quiz.questions.length - 1;
                    });
                },

                async parseExcel(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.excelLoading = true;
                    const fd = new FormData();
                    fd.append('file', file);

                    try {
                        const res = await fetch('/api/import/parse', {
                            method: 'POST',
                            headers: { 'X-CSRF-Token': getCookie('csrf_token') },
                            body: fd
                        });
                        const data = await res.json();
                        if (res.ok && Array.isArray(data)) {
                            this.quiz.questions.push(...data);
                            this.showExcelModal = false;

                            this.$nextTick(() => {
                                const sidebar = document.querySelector('.overflow-y-auto');
                                if (sidebar) sidebar.scrollTop = sidebar.scrollHeight;
                                this.currentIndex = this.quiz.questions.length - 1;
                            });

                            alert(`${data.length} soru eklendi!`);
                        } else {
                            alert("Hata: " + (data.detail || "Dosya okunamadƒ±"));
                        }
                    } catch (e) {
                        alert("Y√ºkleme hatasƒ±");
                    } finally {
                        this.excelLoading = false;
                        // Reset input
                        event.target.value = '';
                    }
                },

                get currentQuestion() {
                    return this.quiz.questions[this.currentIndex];
                },

                getTypeIcon(type) {
                    const icons = {
                        'multiple_choice': 'üí†',
                        'true_false': '‚öñÔ∏è',
                        'typing': '‚å®Ô∏è',
                        'marked_answer': 'üìç',
                        'poll': 'üìä'
                    };
                    return icons[type] || '‚ùì';
                },

                getTypeName(type) {
                    const names = {
                        'multiple_choice': 'Quiz',
                        'true_false': 'Doƒüru/Yanlƒ±≈ü',
                        'typing': 'Kƒ±sa Cevap',
                        'marked_answer': 'ƒ∞≈üaretli Cevap',
                        'poll': 'Oylama'
                    };
                    return names[type] || type;
                },

                formatTime(seconds) {
                    return seconds + ' sn';
                },

                formatPoints(points) {
                    if (points === 0) return '0 puan';
                    if (points === 2000) return 'ƒ∞ki kat puan';
                    return 'Standart';
                },

                getThemeName(theme) {
                    const themes = {
                        'standard': 'Standart',
                        'winter': 'Kƒ±≈ü',
                        'spring': 'ƒ∞lkbahar',
                        'summer': 'Yaz',
                        'autumn': 'Sonbahar',
                        'ukraine': 'Ukrayna'
                    };
                    return themes[theme] || theme;
                },

                addQuestion() {
                    this.quiz.questions.push({
                        text: '',
                        time_limit: 20,
                        points: 1000,
                        question_type: 'multiple_choice',
                        image_url: '',
                        options: [
                            { text: '', is_correct: false },
                            { text: '', is_correct: false },
                            { text: '', is_correct: false },
                            { text: '', is_correct: false }
                        ]
                    });
                    this.currentIndex = this.quiz.questions.length - 1;

                    // Allow UI update
                    this.$nextTick(() => {
                        const sidebar = document.querySelector('.overflow-y-auto');
                        if (sidebar) sidebar.scrollTop = sidebar.scrollHeight;
                    });
                },

                removeQuestion(index) {
                    if (this.quiz.questions.length <= 1) return alert("En az bir soru olmalƒ±!");
                    if (confirm("Bu soruyu silmek istediƒüine emin misin?")) {
                        this.quiz.questions.splice(index, 1);
                        if (this.currentIndex >= this.quiz.questions.length) {
                            this.currentIndex = Math.max(0, this.quiz.questions.length - 1);
                        }
                    }
                },

                changeType(type) {
                    // Reset options based on type
                    this.currentQuestion.question_type = type;

                    if (type === 'true_false') {
                        this.currentQuestion.options = [
                            { text: 'True', is_correct: true },
                            { text: 'False', is_correct: false }
                        ];
                    } else if (type === 'typing') {
                        this.currentQuestion.options = [
                            { text: '', is_correct: true }
                        ];
                    } else if (type === 'marked_answer') {
                        this.currentQuestion.options = [
                            { text: '', is_correct: true } // Coordinates stored in text
                        ];
                    } else {
                        // Reset to 4 options if coming from non-standard
                        if (this.currentQuestion.options.length !== 4) {
                            this.currentQuestion.options = [
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false }
                            ];
                        }
                    }
                    this.showTypeSelector = false;
                },

                toggleCorrect(index) {
                    // If multiple choice, toggle (allow single correct for now or multiple? Kahoot usually single for basic)
                    // Let's allow single correct for simplicity unless we add "multi-select" toggle
                    this.currentQuestion.options.forEach((o, i) => {
                        o.is_correct = (i === index);
                    });
                },

                setTrueFalse(index) {
                    this.currentQuestion.options[0].is_correct = (index === 0);
                    this.currentQuestion.options[1].is_correct = (index === 1);
                },

                setTheme(theme) {
                    this.quiz.theme = theme;
                    this.showThemeSelector = false;
                },

                setPin(event) {
                    if (this.currentQuestion.question_type !== 'marked_answer') return;
                    if (!this.currentQuestion.image_url) return;

                    const rect = event.currentTarget.getBoundingClientRect();
                    const x = ((event.clientX - rect.left) / rect.width) * 100;
                    const y = ((event.clientY - rect.top) / rect.height) * 100;

                    this.currentQuestion.options[0].text = `${x.toFixed(2)},${y.toFixed(2)}`;
                },

                async uploadImage(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        this.uploading = true;
                        const response = await fetch('/upload', {
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': getCookie('csrf_token')
                            },
                            body: formData
                        });
                        const data = await response.json();
                        this.currentQuestion.image_url = data.url;
                    } catch (error) {
                        alert('Resim y√ºklenirken hata olu≈ütu');
                    } finally {
                        this.uploading = false;
                    }
                },

                async saveQuiz() {
                    if (!this.quiz.title) {
                        alert("L√ºtfen bir ba≈ülƒ±k girin!");
                        return;
                    }

                    // Validation
                    for (let i = 0; i < this.quiz.questions.length; i++) {
                        const q = this.quiz.questions[i];
                        if (!q.text) {
                            this.currentIndex = i;
                            return alert((i + 1) + '. sorunun metnini girmediniz.');
                        }
                        if (q.question_type === 'poll') continue;

                        if (q.question_type === 'typing') {
                            if (!q.options[0].text) {
                                this.currentIndex = i;
                                return alert((i + 1) + '. soru i√ßin doƒüru cevabƒ± yazmadƒ±nƒ±z.');
                            }
                        } else {
                            if (!q.options.some(o => o.is_correct) && q.question_type !== 'marked_answer') {
                                this.currentIndex = i;
                                return alert((i + 1) + '. soruda doƒüru cevabƒ± se√ßmediniz!');
                            }
                            if (q.question_type === 'marked_answer') {
                                if (!q.image_url) {
                                    this.currentIndex = i;
                                    return alert((i + 1) + '. soru i√ßin (ƒ∞≈üaretli Cevap) bir g√∂rsel eklemelisiniz.');
                                }
                                if (!q.options[0].text) {
                                    this.currentIndex = i;
                                    return alert((i + 1) + '. soru i√ßin g√∂rsel √ºzerine tƒ±klayarak doƒüru yeri i≈üaretleyin.');
                                }
                            }
                        }
                    }

                    try {
                        const isEdit = !!this.quiz.id;
                        const url = isEdit ? `/api/quizzes/${this.quiz.id}` : '/api/quizzes/';
                        const method = isEdit ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': getCookie('csrf_token')
                            },
                            body: JSON.stringify(this.quiz)
                        });

                        if (response.ok) {
                            this.showSuccess = true;
                        } else {
                            const err = await response.json();
                            alert("Hata: " + (err.detail || "Kaydedilemedi"));
                        }
                    } catch (error) {
                        console.error(error);
                        alert("Bir hata olu≈ütu.");
                    }
                }
            }));
        });
    </script>
</body>

</html>