<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiSual - Yarƒ±≈üma Olu≈ütur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/static/js/theme.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            overflow: hidden;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        html:not(.dark) body {
            background-color: #f1f5f9;
            color: #1e293b;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        html:not(.dark) ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        html:not(.dark) ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        html:not(.dark) .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .slide-card {
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        html:not(.dark) .slide-card:hover {
            background-color: #e2e8f0;
        }

        html.dark .slide-card:hover {
            /* Assuming there was a hover effect or default styling */
            background-color: rgba(255, 255, 255, 0.05);
        }

        .slide-card.active {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
        }

        html:not(.dark) .slide-card.active {
            background-color: rgba(99, 102, 241, 0.1);
        }

        /* Indigo 500 */
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        background-color: rgba(99, 102, 241, 0.1);
        }

        .answer-input-container {
            transition: all 0.2s;
        }

        .answer-input-container:focus-within {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
    </style>
    <script>
        // Inject quiz data if in edit mode
        window.serverQuizData = {{ quiz_json | tojson | safe if quiz_json else 'null' }};

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    </script>
</head>

<body class="h-screen flex flex-col relative" x-data="quizEditor">

    <!-- Background Gradients -->
    <div class="absolute inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-indigo-600/20 rounded-full blur-[100px]">
        </div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-purple-600/20 rounded-full blur-[100px]">
        </div>
    </div>

    <!-- TOP NAVBAR -->
    <nav class="h-16 glass-panel border-b-0 flex justify-between items-center px-6 z-20 shadow-lg shrink-0">
        <div class="flex items-center gap-4">
            <a href="/host"
                class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg hover:scale-110 transition cursor-pointer">
                <span class="text-white font-bold">B</span>
            </a>
            <input type="text" x-model="quiz.title"
                class="bg-transparent font-bold text-lg border border-transparent hover:border-slate-700 focus:border-indigo-500 rounded px-3 py-1.5 outline-none transition text-white placeholder-slate-500 w-64"
                placeholder="Yarƒ±≈üma ba≈ülƒ±ƒüƒ± gir...">

            <button @click="showSettings = true"
                class="bg-slate-800/50 hover:bg-slate-700 text-slate-300 hover:text-white px-3 py-1.5 rounded-lg text-sm font-bold transition flex items-center gap-2">
                <span>‚öôÔ∏è</span> Ayarlar
            </button>
        </div>

        <div class="flex gap-3">
            <button @click="window.location.href='/'"
                class="px-4 py-2 font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition">√áƒ±k</button>
            <button @click="saveQuiz()"
                class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white px-6 py-2 rounded-xl font-bold transition shadow-lg hover:shadow-indigo-500/25 flex items-center gap-2">
                <span>üíæ</span> Kaydet
            </button>
        </div>
    </nav>

    <!-- MAIN EDITOR AREA -->
    <div class="flex-1 flex overflow-hidden z-10 relative">

        <!-- LEFT SIDEBAR (SLIDES) -->
        <div
            class="w-52 glass-panel border-r-0 border-r border-slate-800 flex flex-col p-3 overflow-y-auto shrink-0 space-y-3 custom-scrollbar">
            <div class="flex flex-col gap-3">
                <template x-for="(q, index) in quiz.questions" :key="index">
                    <div @click="currentIndex = index"
                        class="slide-card p-3 rounded-xl border border-slate-700 cursor-pointer relative group flex flex-col gap-2 h-28 hover:bg-slate-800/80 bg-slate-900/50"
                        :class="{'active': currentIndex === index}">

                        <div class="text-[10px] font-bold text-slate-500 flex justify-between uppercase tracking-wider">
                            <span x-text="index + 1" class="bg-slate-800 px-1.5 py-0.5 rounded"></span>
                            <button @click.stop="removeQuestion(index)"
                                class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded px-1 transition">üóëÔ∏è</button>
                        </div>

                        <!-- Mini Preview -->
                        <div
                            class="flex-1 bg-slate-800/50 rounded-lg flex items-center justify-center overflow-hidden border border-slate-700/50">
                            <span class="text-[0.6rem] text-slate-400 text-center px-1 truncate"
                                x-text="q.text || 'Soru ...'"></span>
                        </div>

                        <div class="flex justify-center gap-1">
                            <div class="w-1.5 h-1.5 rounded-full bg-red-500/80"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-blue-500/80"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-yellow-500/80"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-green-500/80"></div>
                        </div>
                    </div>
                </template>
            </div>

            <button @click="addQuestion()"
                class="mt-4 bg-slate-800 hover:bg-indigo-600 border border-slate-700 hover:border-indigo-500 text-slate-300 hover:text-white py-3 rounded-xl font-bold transition shadow-lg text-sm flex items-center justify-center gap-2 group">
                <span class="group-hover:scale-110 transition">+</span> Soru Ekle
            </button>

            <div class="mt-2 flex gap-2">
                <button @click="showAiModal = true"
                    class="flex-1 bg-gradient-to-br from-purple-900/50 to-purple-600/20 hover:from-purple-600 hover:to-purple-500 border border-purple-500/30 hover:border-purple-400 text-purple-200 hover:text-white py-2 rounded-xl font-bold text-xs transition"
                    title="AI ile Ekle">
                    ‚ú® AI
                </button>
                <button @click="showExcelModal = true"
                    class="flex-1 bg-gradient-to-br from-emerald-900/50 to-emerald-600/20 hover:from-emerald-600 hover:to-emerald-500 border border-emerald-500/30 hover:border-emerald-400 text-emerald-200 hover:text-white py-2 rounded-xl font-bold text-xs transition"
                    title="Excel'den Ekle">
                    üìä Excel
                </button>
            </div>
        </div>

        <!-- CENTER CANVAS -->
        <div class="flex-1 bg-slate-950 p-8 flex flex-col items-center overflow-y-auto relative transition-all duration-500 custom-scrollbar"
            :class="{
                'bg-[url(\'https://www.transparenttextures.com/patterns/cubes.png\')]': quiz.theme === 'standard',
                'bg-blue-950': quiz.theme === 'winter',
                'bg-emerald-950': quiz.theme === 'spring',
                'bg-amber-950': quiz.theme === 'summer',
                'bg-orange-950': quiz.theme === 'autumn',
                'bg-slate-900': quiz.theme === 'ukraine'
             }">

            <!-- Canvas Overlay for Readability -->
            <div class="absolute inset-0 bg-black/20 pointer-events-none"></div>

            <div class="w-full max-w-5xl flex-1 flex flex-col gap-6 z-10">

                <!-- Question Input -->
                <div class="glass-panel p-1 rounded-2xl shadow-xl">
                    <input type="text" x-model="currentQuestion.text"
                        class="w-full text-center text-3xl font-bold p-6 bg-transparent outline-none placeholder-slate-600 text-white rounded-xl focus:bg-slate-800/50 transition"
                        placeholder="Sorunu girmeye ba≈üla">
                </div>

                <!-- Media Area -->
                <div class="flex-1 glass-panel rounded-2xl flex items-center justify-center min-h-[300px] border-2 border-dashed border-slate-700 hover:border-indigo-500 relative group cursor-pointer transition hover:bg-slate-800/30 overflow-hidden"
                    @click="$refs.fileInput.click()">

                    <input type="file" x-ref="fileInput" class="hidden" accept="image/*" @change="uploadImage($event)">

                    <div class="text-center">
                        <div class="text-6xl mb-4 opacity-30 grayscale group-hover:grayscale-0 transition duration-500">
                            üñºÔ∏è</div>
                        <div class="font-bold text-slate-500 group-hover:text-indigo-400"
                            x-show="!currentQuestion.image_url">
                            G√∂rsel Y√ºkle<br>
                            <span class="text-xs font-normal opacity-50">(veya s√ºr√ºkle bƒ±rak)</span>
                        </div>
                    </div>

                    <!-- Image Preview -->
                    <div x-show="currentQuestion.image_url"
                        class="absolute inset-0 w-full h-full bg-slate-900/50 group-hover:opacity-50 transition p-8">
                        <img :src="currentQuestion.image_url" class="w-full h-full object-contain drop-shadow-2xl">
                    </div>

                    <!-- Hover Action -->
                    <div x-show="currentQuestion.image_url"
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-10">
                        <span
                            class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition">G√∂rseli
                            Deƒüi≈ütir</span>
                    </div>
                </div>

                <!-- Answer Grid -->
                <!-- Answer Grid (Dynamic) -->
                <div class="grid grid-cols-2 gap-4 h-64"
                    x-show="['multiple_choice', 'poll'].includes(currentQuestion.question_type)">
                    <template x-for="(opt, idx) in currentQuestion.options" :key="idx">
                        <div class="answer-input-container rounded-2xl p-2 flex items-center gap-2 shadow-lg group transition relative overflow-hidden"
                            :class="{
                                'bg-red-600': idx === 0,
                                'bg-blue-600': idx === 1,
                                'bg-amber-500': idx === 2,
                                'bg-emerald-600': idx === 3
                             }">
                            <!-- Icon -->
                            <div class="w-12 h-full bg-black/10 flex items-center justify-center text-white text-2xl font-black rounded-l-xl"
                                x-text="['‚ñ≤','‚óÜ','‚óè','‚ñ†'][idx]"></div>

                            <!-- Input Wrapper -->
                            <div class="flex-1 h-full bg-white flex items-center px-4 relative rounded-r-xl">
                                <input type="text" x-model="opt.text"
                                    class="w-full h-full outline-none font-bold text-lg text-slate-800 placeholder-slate-300"
                                    :placeholder="'Cevap ' + (idx+1)">

                                <button x-show="currentQuestion.question_type !== 'poll'" @click="toggleCorrect(idx)"
                                    class="w-8 h-8 rounded-full border-2 flex items-center justify-center ml-2 transition hover:scale-110"
                                    :class="opt.is_correct ? 'bg-green-500 border-green-500 text-white shadow-lg shadow-green-500/30' : 'border-slate-200 text-transparent hover:border-slate-300'">
                                    ‚úì
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- True/False Grid -->
                <div class="grid grid-cols-2 gap-4 h-64" x-show="currentQuestion.question_type === 'true_false'">
                    <div class="h-full bg-blue-600 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-[1.02] active:scale-95 shadow-xl relative border-4"
                        :class="currentQuestion.options[0].is_correct ? 'border-white/50 shadow-blue-500/50' : 'border-transparent opacity-80 hover:opacity-100'"
                        @click="setTrueFalse(0)">
                        <div class="text-white text-4xl font-black mb-2 drop-shadow-md">DOƒûRU</div>
                        <div class="text-white/30 text-8xl absolute bottom-[-20px] right-[-10px] rotate-[-15deg]">‚óÜ
                        </div>
                        <div x-show="currentQuestion.options[0].is_correct"
                            class="absolute top-4 right-4 bg-white text-blue-600 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold shadow-lg">
                            ‚úì
                        </div>
                    </div>
                    <div class="h-full bg-red-600 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-[1.02] active:scale-95 shadow-xl relative border-4"
                        :class="currentQuestion.options[1].is_correct ? 'border-white/50 shadow-red-500/50' : 'border-transparent opacity-80 hover:opacity-100'"
                        @click="setTrueFalse(1)">
                        <div class="text-white text-4xl font-black mb-2 drop-shadow-md">YANLI≈û</div>
                        <div class="text-white/30 text-8xl absolute bottom-[-20px] right-[-10px] rotate-[-15deg]">‚ñ≤
                        </div>
                        <div x-show="currentQuestion.options[1].is_correct"
                            class="absolute top-4 right-4 bg-white text-red-600 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold shadow-lg">
                            ‚úì
                        </div>
                    </div>
                </div>

                <!-- Type Answer -->
                <div class="w-full h-64 glass-panel rounded-2xl p-8 flex flex-col items-center justify-center shadow-lg"
                    x-show="currentQuestion.question_type === 'typing'">
                    <h3 class="text-slate-400 font-bold mb-6 uppercase tracking-widest text-sm">Doƒüru Cevabƒ± Yazƒ±n</h3>
                    <input type="text" x-model="currentQuestion.options[0].text"
                        class="w-full max-w-lg text-center text-4xl font-black bg-transparent border-b-4 border-slate-700 focus:border-indigo-500 outline-none p-4 transition placeholder-slate-700 text-white"
                        placeholder="Cevap buraya...">
                    <p class="mt-6 text-xs text-slate-500">B√ºy√ºk/k√º√ß√ºk harf duyarlƒ±lƒ±ƒüƒ± yoktur.</p>
                </div>

                <!-- Pin Drop (Marked Answer) -->
                <div class="w-full h-auto glass-panel rounded-2xl p-6 flex flex-col items-center justify-center shadow-lg"
                    x-show="currentQuestion.question_type === 'marked_answer'">
                    <div class="text-center mb-6">
                        <h3 class="text-slate-400 font-bold uppercase tracking-widest text-sm">Doƒüru Yeri ƒ∞≈üaretleyin
                        </h3>
                        <p class="text-xs text-slate-500 mt-1">G√∂rselin √ºzerinde doƒüru cevabƒ±n bulunduƒüu noktaya
                            tƒ±klayƒ±n.</p>
                    </div>

                    <!-- Image Container for Pinning -->
                    <div class="relative w-full max-w-2xl border-2 border-slate-700 rounded-xl overflow-hidden cursor-crosshair group shadow-2xl"
                        x-show="currentQuestion.image_url" @click="setPin($event)">

                        <img :src="currentQuestion.image_url" class="w-full h-auto object-contain block">

                        <!-- Pin Marker -->
                        <div x-show="currentQuestion.options[0].text"
                            class="absolute w-10 h-10 -ml-5 -mt-10 text-5xl drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)] transition-all duration-200 pointer-events-none"
                            :style="'left: ' + (currentQuestion.options[0].text ? currentQuestion.options[0].text.split(',')[0] + '%' : '50%') + '; top: ' + (currentQuestion.options[0].text ? currentQuestion.options[0].text.split(',')[1] + '%' : '50%')">
                            üìç
                        </div>
                    </div>

                    <div x-show="!currentQuestion.image_url"
                        class="p-8 text-red-300 font-bold bg-red-500/10 rounded-xl border border-red-500/20 text-center animate-pulse">
                        ‚ö†Ô∏è √ñnce yukarƒ±dan bir g√∂rsel eklemelisiniz.
                    </div>
                </div>

            </div>
        </div>

        <!-- RIGHT SIDEBAR (SETTINGS) -->
        <div
            class="w-64 glass-panel border-l-0 border-l border-slate-800 p-4 shrink-0 flex flex-col gap-6 overflow-y-auto z-20">

            <!-- Type Selector Trigger -->
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Soru
                    T√ºr√º</label>
                <button @click="showTypeSelector = true"
                    class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-indigo-500 rounded-xl p-3 flex items-center justify-between shadow-md transition group">
                    <div class="flex items-center gap-3">
                        <span class="text-xl" x-text="getTypeIcon(currentQuestion.question_type)"></span>
                        <span class="font-bold text-slate-200"
                            x-text="getTypeName(currentQuestion.question_type)"></span>
                    </div>
                </button>
            </div>

            <!-- Time Limit -->
            <div>
                <label
                    class="block text-[10px] font-bold text-slate-500 uppercase mb-2 flex items-center gap-1 tracking-wider">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Zaman sƒ±nƒ±rƒ±
                </label>
                <button @click="showTimeSelector = true"
                    class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-indigo-500 rounded-xl p-3 font-bold text-slate-200 flex justify-between items-center shadow-md transition">
                    <span x-text="formatTime(currentQuestion.time_limit)"></span>
                    <span class="text-slate-500 text-xs">‚ñº</span>
                </button>
            </div>

            <!-- Points -->
            <div>
                <label
                    class="block text-[10px] font-bold text-slate-500 uppercase mb-2 flex items-center gap-1 tracking-wider">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Puan
                </label>
                <button @click="showPointsSelector = true"
                    class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-indigo-500 rounded-xl p-3 font-bold text-slate-200 flex justify-between items-center shadow-md transition">
                    <span x-text="formatPoints(currentQuestion.points)"></span>
                    <span class="text-slate-500 text-xs">‚ñº</span>
                </button>
            </div>

            <!-- Themes Trigger -->
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Tema</label>
                <button @click="showThemeSelector = true"
                    class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-indigo-500 rounded-xl p-3 font-bold text-slate-200 flex justify-between items-center shadow-md transition">
                    <span x-text="getThemeName(quiz.theme)"></span>
                    <span class="text-xl">üé®</span>
                </button>
            </div>

            <div class="mt-auto pt-8 text-center text-slate-600 text-[10px] text-balance opacity-50">
                BiSual v2.0<br>Premium Editor
            </div>

        </div>

        <!-- Success Modal -->
        <div x-show="showSuccess"
            class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm"
            style="display: none;">
            <div
                class="glass-panel p-8 rounded-2xl text-center max-w-sm mx-auto shadow-2xl animate-bounce border border-indigo-500/50">
                <div class="text-6xl mb-6">üéâ</div>
                <h2 class="text-3xl font-black text-white mb-2">Hazƒ±r!</h2>
                <p class="text-slate-400 mb-8 font-medium">Yarƒ±≈üma ba≈üarƒ±yla kaydedildi.</p>
                <a href="/host"
                    class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-3 rounded-xl font-bold block w-full hover:shadow-lg hover:shadow-indigo-500/30 transition transform hover:scale-105">
                    Ba≈ülat
                </a>
            </div>
        </div>

        <!-- Type Selector Modal -->
        <div x-show="showTypeSelector" @click.self="showTypeSelector = false"
            class="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] backdrop-blur-md"
            style="display: none;">
            <div
                class="glass-panel bg-slate-900/90 p-8 rounded-3xl w-full max-w-3xl shadow-2xl overflow-hidden border border-slate-700">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <span class="text-indigo-400">‚ùñ</span> Soru t√ºr√º se√ß
                    </h2>
                    <button @click="showTypeSelector = false"
                        class="text-slate-400 hover:text-white text-3xl transition hover:rotate-90">√ó</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Quiz -->
                    <button @click="changeType('multiple_choice')"
                        class="p-4 rounded-2xl border hover:border-indigo-500 hover:bg-indigo-600/20 transition flex flex-col items-center gap-4 text-center h-40 justify-center group"
                        :class="currentQuestion.question_type === 'multiple_choice' ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/50'">
                        <div class="text-4xl group-hover:scale-110 transition">üí†</div>
                        <span class="font-bold text-slate-200 group-hover:text-white">Quiz</span>
                    </button>

                    <!-- True/False -->
                    <button @click="changeType('true_false')"
                        class="p-4 rounded-2xl border hover:border-indigo-500 hover:bg-indigo-600/20 transition flex flex-col items-center gap-4 text-center h-40 justify-center group"
                        :class="currentQuestion.question_type === 'true_false' ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/50'">
                        <div class="text-4xl flex gap-1 group-hover:scale-110 transition"><span
                                class="text-blue-500">‚ñÆ</span><span class="text-red-500">‚ñÆ</span></div>
                        <span class="font-bold text-slate-200 group-hover:text-white">Doƒüru/Yanlƒ±≈ü</span>
                    </button>

                    <!-- Type Answer -->
                    <button @click="changeType('typing')"
                        class="p-4 rounded-2xl border hover:border-indigo-500 hover:bg-indigo-600/20 transition flex flex-col items-center gap-4 text-center h-40 justify-center group"
                        :class="currentQuestion.question_type === 'typing' ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/50'">
                        <div class="text-4xl group-hover:scale-110 transition">‚å®Ô∏è</div>
                        <span class="font-bold text-slate-200 group-hover:text-white">Kƒ±sa Cevap</span>
                    </button>

                    <!-- Pin Drop -->
                    <button @click="changeType('marked_answer')"
                        class="p-4 rounded-2xl border hover:border-indigo-500 hover:bg-indigo-600/20 transition flex flex-col items-center gap-4 text-center h-40 justify-center group"
                        :class="currentQuestion.question_type === 'marked_answer' ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/50'">
                        <div class="text-4xl group-hover:scale-110 transition">üìç</div>
                        <span class="font-bold text-slate-200 group-hover:text-white">ƒ∞≈üaretli Cevap</span>
                    </button>

                    <!-- Poll -->
                    <button @click="changeType('poll')"
                        class="p-4 rounded-2xl border hover:border-indigo-500 hover:bg-indigo-600/20 transition flex flex-col items-center gap-4 text-center h-40 justify-center group"
                        :class="currentQuestion.question_type === 'poll' ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/50'">
                        <div class="text-4xl group-hover:scale-110 transition">üìä</div>
                        <span class="font-bold text-slate-200 group-hover:text-white">Oylama</span>
                    </button>

                    <!-- Coming Soon -->
                    <button
                        class="p-4 rounded-2xl border border-slate-800 bg-slate-900/50 cursor-not-allowed opacity-40 flex flex-col items-center gap-4 text-center h-40 justify-center grayscale">
                        <div class="text-3xl">üß©</div>
                        <span class="font-bold text-slate-500">Puzzle</span>
                    </button>
                    <button
                        class="p-4 rounded-2xl border border-slate-800 bg-slate-900/50 cursor-not-allowed opacity-40 flex flex-col items-center gap-4 text-center h-40 justify-center grayscale">
                        <div class="text-3xl">‚òÅÔ∏è</div>
                        <span class="font-bold text-slate-500">Kelime</span>
                    </button>

                </div>
            </div>
        </div>

        <!-- Time Selector Modal -->
        <div x-show="showTimeSelector" @click.self="showTimeSelector = false"
            class="fixed inset-0 bg-black/60 flex justify-end z-[70] backdrop-blur-sm" style="display: none;"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-x-full"
            x-transition:enter-end="opacity-100 translate-x-0" x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 translate-x-0" x-transition:leave-end="opacity-0 translate-x-full">
            <div
                class="w-80 glass-panel bg-slate-900/95 h-full shadow-2xl p-6 overflow-y-auto flex flex-col gap-6 border-l border-slate-700">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white">Zaman sƒ±nƒ±rƒ±</h2>
                    <button @click="showTimeSelector = false"
                        class="text-slate-400 hover:text-white text-2xl">√ó</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <template x-for="time in [5, 10, 20, 30, 60, 90, 120, 240]">
                        <button @click="currentQuestion.time_limit = time; showTimeSelector = false"
                            class="p-4 rounded-xl border hover:border-indigo-500 hover:bg-slate-800 transition font-bold text-slate-300"
                            :class="currentQuestion.time_limit === time ? 'border-indigo-500 bg-indigo-600/20 text-white' : 'border-slate-700 bg-slate-800/30'"
                            x-text="formatTime(time)"></button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Points Selector Modal -->
        <div x-show="showPointsSelector" @click.self="showPointsSelector = false"
            class="fixed inset-0 bg-black/60 flex justify-end z-[70] backdrop-blur-sm" style="display: none;"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-x-full"
            x-transition:enter-end="opacity-100 translate-x-0" x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 translate-x-0" x-transition:leave-end="opacity-0 translate-x-full">
            <div
                class="w-80 glass-panel bg-slate-900/95 h-full shadow-2xl p-6 overflow-y-auto flex flex-col gap-6 border-l border-slate-700">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white">Puanlar</h2>
                    <button @click="showPointsSelector = false"
                        class="text-slate-400 hover:text-white text-2xl">√ó</button>
                </div>
                <div class="flex flex-col gap-3">
                    <!-- Standard -->
                    <button @click="currentQuestion.points = 1000; showPointsSelector = false"
                        class="p-6 rounded-2xl border text-left relative group transition flex flex-col justify-center gap-2"
                        :class="currentQuestion.points === 1000 ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/30 hover:bg-slate-800 hover:border-indigo-400'">
                        <div class="flex justify-between items-center w-full">
                            <span class="font-bold text-white text-lg">Standart</span>
                            <span x-show="currentQuestion.points === 1000"
                                class="text-xl font-bold text-indigo-400">‚úì</span>
                        </div>
                        <span class="text-xs text-slate-400">Doƒüru cevaplarƒ± normal puanla √∂d√ºllendir.</span>
                    </button>

                    <!-- Double Points -->
                    <button @click="currentQuestion.points = 2000; showPointsSelector = false"
                        class="p-6 rounded-2xl border text-left relative group transition flex flex-col justify-center gap-2"
                        :class="currentQuestion.points === 2000 ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/30 hover:bg-slate-800 hover:border-indigo-400'">
                        <div class="flex justify-between items-center w-full">
                            <span class="font-bold text-white text-lg">ƒ∞ki kat puan</span>
                            <span x-show="currentQuestion.points === 2000"
                                class="text-xl font-bold text-indigo-400">‚úì</span>
                        </div>
                        <span class="text-xs text-slate-400">Doƒüru cevaplar i√ßin iki kat puan ver.</span>
                    </button>

                    <!-- No Points -->
                    <button @click="currentQuestion.points = 0; showPointsSelector = false"
                        class="p-6 rounded-2xl border text-left relative group transition flex flex-col justify-center gap-2"
                        :class="currentQuestion.points === 0 ? 'border-indigo-500 bg-indigo-600/20' : 'border-slate-700 bg-slate-800/30 hover:bg-slate-800 hover:border-indigo-400'">
                        <div class="flex justify-between items-center w-full">
                            <span class="font-bold text-white text-lg">0 puan</span>
                            <span x-show="currentQuestion.points === 0"
                                class="text-xl font-bold text-indigo-400">‚úì</span>
                        </div>
                        <span class="text-xs text-slate-400">Sorunun √∂d√ºl√ºn√º azalt ve puanlarƒ± kaldƒ±r.</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div x-show="showThemeSelector" @click.self="showThemeSelector = false"
        class="fixed inset-0 bg-black/60 flex justify-end z-[70] backdrop-blur-sm" style="display: none;" x-transition>
        <div
            class="w-80 glass-panel bg-slate-900/95 h-full shadow-2xl p-6 overflow-y-auto flex flex-col gap-6 border-l border-slate-700">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Temalar</h2>
                <button @click="showThemeSelector = false" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div>
                <div
                    class="flex justify-between items-center text-slate-400 font-bold text-xs uppercase tracking-wider mb-3">
                    <span>Temalarƒ±n</span>
                    <span>‚ñº</span>
                </div>
                <div
                    class="border border-dashed border-slate-600 rounded-xl h-24 flex items-center justify-center text-slate-500 cursor-pointer hover:border-indigo-500 hover:text-indigo-400 hover:bg-slate-800/50 transition">
                    <span class="text-4xl font-light">+</span>
                </div>
            </div>

            <div>
                <div
                    class="flex justify-between items-center text-slate-400 font-bold text-xs uppercase tracking-wider mb-3">
                    <span>√úcretsiz</span>
                    <span>‚ñº</span>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- Standard -->
                    <div @click="setTheme('standard')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-indigo-900 border-2 transition relative overflow-hidden"
                            :class="quiz.theme === 'standard' ? 'border-indigo-400 ring-2 ring-indigo-400/30' : 'border-transparent opacity-80 group-hover:opacity-100'">
                            <div
                                class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-50">
                            </div>
                        </div>
                        <div
                            class="text-center text-[10px] font-bold mt-2 text-slate-400 group-hover:text-white uppercase tracking-wider">
                            Standard</div>
                    </div>

                    <!-- Winter -->
                    <div @click="setTheme('winter')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-blue-900 border-2 transition relative overflow-hidden"
                            :class="quiz.theme === 'winter' ? 'border-indigo-400 ring-2 ring-indigo-400/30' : 'border-transparent opacity-80 group-hover:opacity-100'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">‚ùÑÔ∏è</div>
                        </div>
                        <div
                            class="text-center text-[10px] font-bold mt-2 text-slate-400 group-hover:text-white uppercase tracking-wider">
                            Winter</div>
                    </div>

                    <!-- Spring -->
                    <div @click="setTheme('spring')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-emerald-900 border-2 transition relative overflow-hidden"
                            :class="quiz.theme === 'spring' ? 'border-indigo-400 ring-2 ring-indigo-400/30' : 'border-transparent opacity-80 group-hover:opacity-100'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">üå∏</div>
                        </div>
                        <div
                            class="text-center text-[10px] font-bold mt-2 text-slate-400 group-hover:text-white uppercase tracking-wider">
                            Spring</div>
                    </div>

                    <!-- Summer -->
                    <div @click="setTheme('summer')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-amber-900 border-2 transition relative overflow-hidden"
                            :class="quiz.theme === 'summer' ? 'border-indigo-400 ring-2 ring-indigo-400/30' : 'border-transparent opacity-80 group-hover:opacity-100'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">‚òÄÔ∏è</div>
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'summer' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Summer</div>
                    </div>

                    <!-- Autumn -->
                    <div @click="setTheme('autumn')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-orange-200 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'autumn' ? 'border-indigo-600' : 'border-transparent'">
                            <div class="absolute inset-0 text-4xl flex items-center justify-center">üçÇ</div>
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'autumn' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Autumn</div>
                    </div>
                    <!-- Ukraine -->
                    <div @click="setTheme('ukraine')" class="cursor-pointer group">
                        <div class="h-24 rounded-lg bg-gradient-to-b from-blue-500 to-yellow-400 border-4 transition relative overflow-hidden"
                            :class="quiz.theme === 'ukraine' ? 'border-indigo-600' : 'border-transparent'">
                        </div>
                        <div class="text-center text-xs font-bold mt-1 text-gray-700 group-hover:text-indigo-600"
                            :class="quiz.theme === 'ukraine' ? 'bg-indigo-600 text-white rounded px-2 py-0.5 inline-block' : ''">
                            Support Ukraine</div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    </div>

    <!-- AI SELECTION MODAL -->
    <div x-show="showAiModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative flex flex-col max-h-[80vh]"
            @click.away="showAiModal = false">
            <h2 class="text-2xl font-black text-gray-800 mb-4">‚ú® AI Soru √úretici</h2>

            <!-- Step 1: Input -->
            <div x-show="!aiQuestions.length" class="space-y-4">
                <input type="text" x-model="aiTopic" placeholder="Konu girin (√∂rn: Fotosentez)"
                    class="w-full border p-3 rounded-lg text-lg outline-none focus:border-purple-500">

                <div class="grid grid-cols-2 gap-4">
                    <input type="number" x-model="aiCount" placeholder="Sayƒ±" class="w-full border p-3 rounded-lg"
                        min="1" max="20">
                    <select x-model="aiDifficulty" class="w-full border p-3 rounded-lg">
                        <option value="easy">Kolay</option>
                        <option value="medium">Orta</option>
                        <option value="hard">Zor</option>
                    </select>
                </div>

                <!-- New Options -->
                <div class="grid grid-cols-3 gap-4">
                    <!-- Type -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">T√ºr</label>
                        <select x-model="aiType" class="w-full border p-2 rounded-lg mt-1 text-sm bg-gray-50">
                            <option value="multiple_choice">Quiz</option>
                            <option value="true_false">Doƒüru/Yanlƒ±≈ü</option>
                            <option value="typing">Kƒ±sa Cevap</option>
                        </select>
                    </div>
                    <!-- Time -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">S√ºre</label>
                        <select x-model="aiTime" class="w-full border p-2 rounded-lg mt-1 text-sm bg-gray-50">
                            <option value="5">5 sn</option>
                            <option value="10">10 sn</option>
                            <option value="20">20 sn</option>
                            <option value="30">30 sn</option>
                            <option value="60">60 sn</option>
                        </select>
                    </div>
                    <!-- Points -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Puan</label>
                        <select x-model="aiPoints" class="w-full border p-2 rounded-lg mt-1 text-sm bg-gray-50">
                            <option value="1000">Standart</option>
                            <option value="2000">ƒ∞ki Kat</option>
                            <option value="0">Puan Yok</option>
                        </select>
                    </div>
                </div>

                <button @click="fetchAiQuestions()" :disabled="aiLoading"
                    class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 disabled:opacity-50">
                    <span x-show="!aiLoading">Sorularƒ± Getir</span>
                    <span x-show="aiLoading" class="animate-pulse">√úretiliyor...</span>
                </button>
            </div>

            <!-- Step 2: Selection -->
            <div x-show="aiQuestions.length > 0" class="flex-1 overflow-hidden flex flex-col">
                <div class="flex-1 overflow-y-auto space-y-2 mb-4 p-2 border rounded bg-gray-50">
                    <template x-for="(q, idx) in aiQuestions" :key="idx">
                        <div class="flex items-start gap-3 p-3 bg-white rounded shadow-sm cursor-pointer"
                            @click="q.selected = !q.selected" :class="q.selected ? 'ring-2 ring-purple-500' : ''">
                            <div class="mt-1 w-5 h-5 border-2 rounded flex items-center justify-center"
                                :class="q.selected ? 'bg-purple-500 border-purple-500 text-white' : 'border-gray-300'">
                                <span x-show="q.selected" class="text-xs">‚úì</span>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800" x-text="q.text"></div>
                                <div class="text-xs text-gray-400 mt-1" x-text="q.options.find(o=>o.is_correct)?.text">
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="flex gap-3">
                    <button @click="aiQuestions = []"
                        class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Geri</button>
                    <button @click="addSelectedAiQuestions()"
                        class="flex-1 bg-purple-600 text-white font-bold py-2 rounded hover:bg-purple-700">
                        Se√ßilenleri Ekle (<span x-text="aiQuestions.filter(q=>q.selected).length"></span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- EXCEL PARSE MODAL -->
    <div x-show="showExcelModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative" @click.away="showExcelModal = false">
            <h2 class="text-2xl font-black text-gray-800 mb-4">üìä Excel'den Ekle</h2>

            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-emerald-500 transition"
                @click="$refs.excelParseInput.click()">
                <div x-show="!excelLoading">
                    <div class="text-4xl mb-2">üìÇ</div>
                    <div class="font-bold text-gray-500">Dosya Se√ß (.xlsx)</div>
                </div>
                <div x-show="excelLoading" class="text-emerald-500 font-bold animate-pulse">
                    Y√ºkleniyor...
                </div>
            </div>
            <input type="file" x-ref="excelParseInput" class="hidden" accept=".xlsx" @change="parseExcel($event)">

            <div class="mt-4 text-center">
                <a href="/api/import/template" class="text-xs text-indigo-500 underline">√ñrnek ≈ûablon indir</a>
            </div>
        </div>
    </div>

    </div>

    <!-- SETTINGS MODAL -->
    <div x-show="showSettings" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative" @click.away="showSettings = false"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-90"
            x-transition:enter-end="opacity-100 scale-100">

            <h2 class="text-2xl font-black text-gray-800 mb-6">Yarƒ±≈üma Ayarlarƒ±</h2>

            <div class="space-y-6">
                <!-- Player Screen -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-gray-800">üì± Oyuncu Ekranƒ±</div>
                        <div class="text-xs text-gray-500">Sorularƒ± telefonda g√∂ster</div>
                    </div>
                    <button @click="quiz.settings.show_question_on_player = !quiz.settings.show_question_on_player"
                        class="w-12 h-6 rounded-full transition-colors relative"
                        :class="quiz.settings.show_question_on_player ? 'bg-green-500' : 'bg-gray-300'">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform shadow-sm"
                            :class="quiz.settings.show_question_on_player ? 'translate-x-7 left-0' : 'translate-x-1 left-0'">
                        </div>
                    </button>
                </div>

                <!-- Shuffle Options -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-gray-800">üîÄ Karƒ±≈ütƒ±rma</div>
                        <div class="text-xs text-gray-500">≈ûƒ±klarƒ±n yerini karƒ±≈ütƒ±r</div>
                    </div>
                    <button @click="quiz.settings.shuffle_options = !quiz.settings.shuffle_options"
                        class="w-12 h-6 rounded-full transition-colors relative"
                        :class="quiz.settings.shuffle_options ? 'bg-green-500' : 'bg-gray-300'">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform shadow-sm"
                            :class="quiz.settings.shuffle_options ? 'translate-x-7 left-0' : 'translate-x-1 left-0'">
                        </div>
                    </button>
                </div>

                <!-- Leaderboard Frequency -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-gray-800">üèÜ Akƒ±≈ü</div>
                        <div class="text-xs text-gray-500">Her sorudan sonra puan tablosu</div>
                    </div>
                    <button
                        @click="quiz.settings.show_leaderboard_every_question = !quiz.settings.show_leaderboard_every_question"
                        class="w-12 h-6 rounded-full transition-colors relative"
                        :class="quiz.settings.show_leaderboard_every_question ? 'bg-green-500' : 'bg-gray-300'">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform shadow-sm"
                            :class="quiz.settings.show_leaderboard_every_question ? 'translate-x-7 left-0' : 'translate-x-1 left-0'">
                        </div>
                    </button>
                </div>

                <!-- Music Selection -->
                <div>
                    <div class="font-bold text-gray-800 mb-2">üéµ M√ºzik Temasƒ±</div>
                    <select x-model="quiz.settings.music_theme"
                        class="w-full bg-gray-100 border border-gray-300 rounded-lg p-2 outline-none focus:border-indigo-500">
                        <option value="energetic">Enerjik (Standart)</option>
                        <option value="chill">Sakin & Chill</option>
                        <option value="suspense">Gerilim & Aksiyon</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button @click="showSettings = false"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">Tamam</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('quizEditor', () => ({
                currentIndex: 0,
                showSuccess: false,
                showSettings: false,
                showTypeSelector: false,
                showTimeSelector: false,
                showPointsSelector: false,
                showThemeSelector: false,
                showAiModal: false,
                showExcelModal: false,
                aiTopic: '',
                aiCount: 5,
                aiDifficulty: 'medium',
                aiType: 'multiple_choice',
                aiTime: '20',
                aiPoints: '1000',
                aiLoading: false,
                aiQuestions: [],
                excelLoading: false,
                uploading: false,
                toasts: [], // Toast queue

                showToast(message, type = 'info') {
                    const id = Date.now();
                    this.toasts.push({ id, message, type });
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 3000);
                },
                quiz: {
                    title: '',
                    description: '',
                    theme: 'standard',
                    settings: {
                        show_question_on_player: false,
                        shuffle_options: false,
                        show_leaderboard_every_question: true,
                        music_theme: 'energetic'
                    },
                    questions: [
                        {
                            text: '',
                            time_limit: 20,
                            points: 1000,
                            question_type: 'multiple_choice',
                            image_url: '',
                            options: [
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false }
                            ]
                        }
                    ]
                },

                init() {
                    // Watch for quiz_json from server template
                    if (window.serverQuizData) {
                        this.quiz = window.serverQuizData;
                    }
                },

                async fetchAiQuestions() {
                    if (!this.aiTopic) return this.showToast("L√ºtfen bir konu girin.", "error");
                    this.aiLoading = true;
                    try {
                        const res = await fetch('/api/ai/preview', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': getCookie('csrf_token')
                            },
                            body: JSON.stringify({
                                topic: this.aiTopic,
                                count: parseInt(this.aiCount),
                                difficulty: this.aiDifficulty,
                                type: this.aiType,
                                time_limit: parseInt(this.aiTime),
                                points: parseInt(this.aiPoints)
                            })
                        });
                        const data = await res.json();
                        if (Array.isArray(data)) {
                            this.aiQuestions = data.map(q => ({ ...q, selected: true })); // Default select all
                            this.showToast(`${data.length} soru √ºretildi!`, "success");
                        } else {
                            this.showToast("Yapay zeka soru √ºretemedi.", "error");
                        }
                    } catch (e) {
                        this.showToast("Sunucu hatasƒ±: " + e.message, "error");
                    } finally {
                        this.aiLoading = false;
                    }
                },

                addSelectedAiQuestions() {
                    const selected = this.aiQuestions.filter(q => q.selected);
                    if (selected.length === 0) return;

                    // Clean up selected property before adding
                    const toAdd = selected.map(({ selected, ...rest }) => rest);

                    this.quiz.questions.push(...toAdd);

                    // Reset
                    this.aiQuestions = [];
                    this.showAiModal = false;
                    this.aiTopic = '';

                    // Scroll to bottom
                    this.$nextTick(() => {
                        const sidebar = document.querySelector('.overflow-y-auto');
                        if (sidebar) sidebar.scrollTop = sidebar.scrollHeight;
                        this.currentIndex = this.quiz.questions.length - 1;
                    });
                },

                async parseExcel(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.excelLoading = true;
                    const fd = new FormData();
                    fd.append('file', file);

                    try {
                        const res = await fetch('/api/import/parse', {
                            method: 'POST',
                            headers: { 'X-CSRF-Token': getCookie('csrf_token') },
                            body: fd
                        });
                        const data = await res.json();
                        if (res.ok && Array.isArray(data)) {
                            this.quiz.questions.push(...data);
                            this.showExcelModal = false;

                            this.$nextTick(() => {
                                const sidebar = document.querySelector('.overflow-y-auto');
                                if (sidebar) sidebar.scrollTop = sidebar.scrollHeight;
                                this.currentIndex = this.quiz.questions.length - 1;
                            });

                            alert(`${data.length} soru eklendi!`);
                        } else {
                            alert("Hata: " + (data.detail || "Dosya okunamadƒ±"));
                        }
                    } catch (e) {
                        alert("Y√ºkleme hatasƒ±");
                    } finally {
                        this.excelLoading = false;
                        // Reset input
                        event.target.value = '';
                    }
                },

                get currentQuestion() {
                    return this.quiz.questions[this.currentIndex];
                },

                getTypeIcon(type) {
                    const icons = {
                        'multiple_choice': 'üí†',
                        'true_false': '‚öñÔ∏è',
                        'typing': '‚å®Ô∏è',
                        'marked_answer': 'üìç',
                        'poll': 'üìä'
                    };
                    return icons[type] || '‚ùì';
                },

                getTypeName(type) {
                    const names = {
                        'multiple_choice': 'Quiz',
                        'true_false': 'Doƒüru/Yanlƒ±≈ü',
                        'typing': 'Kƒ±sa Cevap',
                        'marked_answer': 'ƒ∞≈üaretli Cevap',
                        'poll': 'Oylama'
                    };
                    return names[type] || type;
                },

                formatTime(seconds) {
                    return seconds + ' sn';
                },

                formatPoints(points) {
                    if (points === 0) return '0 puan';
                    if (points === 2000) return 'ƒ∞ki kat puan';
                    return 'Standart';
                },

                getThemeName(theme) {
                    const themes = {
                        'standard': 'Standart',
                        'winter': 'Kƒ±≈ü',
                        'spring': 'ƒ∞lkbahar',
                        'summer': 'Yaz',
                        'autumn': 'Sonbahar',
                        'ukraine': 'Ukrayna'
                    };
                    return themes[theme] || theme;
                },

                addQuestion() {
                    this.quiz.questions.push({
                        text: '',
                        time_limit: 20,
                        points: 1000,
                        question_type: 'multiple_choice',
                        image_url: '',
                        options: [
                            { text: '', is_correct: false },
                            { text: '', is_correct: false },
                            { text: '', is_correct: false },
                            { text: '', is_correct: false }
                        ]
                    });
                    this.currentIndex = this.quiz.questions.length - 1;

                    // Allow UI update
                    this.$nextTick(() => {
                        const sidebar = document.querySelector('.overflow-y-auto');
                        if (sidebar) sidebar.scrollTop = sidebar.scrollHeight;
                    });
                },

                removeQuestion(index) {
                    if (this.quiz.questions.length <= 1) return alert("En az bir soru olmalƒ±!");
                    if (confirm("Bu soruyu silmek istediƒüine emin misin?")) {
                        this.quiz.questions.splice(index, 1);
                        if (this.currentIndex >= this.quiz.questions.length) {
                            this.currentIndex = Math.max(0, this.quiz.questions.length - 1);
                        }
                    }
                },

                changeType(type) {
                    // Reset options based on type
                    this.currentQuestion.question_type = type;

                    if (type === 'true_false') {
                        this.currentQuestion.options = [
                            { text: 'True', is_correct: true },
                            { text: 'False', is_correct: false }
                        ];
                    } else if (type === 'typing') {
                        this.currentQuestion.options = [
                            { text: '', is_correct: true }
                        ];
                    } else if (type === 'marked_answer') {
                        this.currentQuestion.options = [
                            { text: '', is_correct: true } // Coordinates stored in text
                        ];
                    } else {
                        // Reset to 4 options if coming from non-standard
                        if (this.currentQuestion.options.length !== 4) {
                            this.currentQuestion.options = [
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false },
                                { text: '', is_correct: false }
                            ];
                        }
                    }
                    this.showTypeSelector = false;
                },

                toggleCorrect(index) {
                    // If multiple choice, toggle (allow single correct for now or multiple? Kahoot usually single for basic)
                    // Let's allow single correct for simplicity unless we add "multi-select" toggle
                    this.currentQuestion.options.forEach((o, i) => {
                        o.is_correct = (i === index);
                    });
                },

                setTrueFalse(index) {
                    this.currentQuestion.options[0].is_correct = (index === 0);
                    this.currentQuestion.options[1].is_correct = (index === 1);
                },

                setTheme(theme) {
                    this.quiz.theme = theme;
                    this.showThemeSelector = false;
                },

                setPin(event) {
                    if (this.currentQuestion.question_type !== 'marked_answer') return;
                    if (!this.currentQuestion.image_url) return;

                    const rect = event.currentTarget.getBoundingClientRect();
                    const x = ((event.clientX - rect.left) / rect.width) * 100;
                    const y = ((event.clientY - rect.top) / rect.height) * 100;

                    this.currentQuestion.options[0].text = `${x.toFixed(2)},${y.toFixed(2)}`;
                },

                async uploadImage(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        this.uploading = true;
                        const response = await fetch('/upload', {
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': getCookie('csrf_token')
                            },
                            body: formData
                        });
                        const data = await response.json();
                        this.currentQuestion.image_url = data.url;
                    } catch (error) {
                        alert('Resim y√ºklenirken hata olu≈ütu');
                    } finally {
                        this.uploading = false;
                    }
                },

                async saveQuiz() {
                    if (!this.quiz.title) {
                        alert("L√ºtfen bir ba≈ülƒ±k girin!");
                        return;
                    }

                    // Validation
                    for (let i = 0; i < this.quiz.questions.length; i++) {
                        const q = this.quiz.questions[i];
                        if (!q.text) {
                            this.currentIndex = i;
                            return alert((i + 1) + '. sorunun metnini girmediniz.');
                        }
                        if (q.question_type === 'poll') continue;

                        if (q.question_type === 'typing') {
                            if (!q.options[0].text) {
                                this.currentIndex = i;
                                return this.showToast(`${i + 1}. soru i√ßin g√∂rsel √ºzerine tƒ±klayarak doƒüru yeri i≈üaretleyin.`, "error");
                            }
                        }
                        if (q.question_type !== 'poll' && !q.options.some(o => o.is_correct)) {
                            return this.showToast(`${i + 1}. soruda doƒüru cevabƒ± se√ßmediniz!`, "error");
                        }
                    }

                    try {
                        let method = 'POST';
                        let url = '/api/quizzes/';

                        if (this.quiz.id) {
                            method = 'PUT';
                            url = `/api/quizzes/${this.quiz.id}`;
                        }

                        const res = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': getCookie('csrf_token')
                            },
                            body: JSON.stringify(this.quiz)
                        });

                        if (res.ok) {
                            const data = await res.json();
                            this.showToast("Yarƒ±≈üma ba≈üarƒ±yla kaydedildi!", "success");
                            this.showSuccess = true;
                        } else {
                            const err = await res.json();
                            this.showToast("Hata: " + (err.detail || "Kaydedilemedi"), "error");
                        }
                    } catch (e) {
                        this.showToast("Baƒülantƒ± hatasƒ±!", "error");
                    }
                }
            }));
        });
    </script>
</body>

</html>